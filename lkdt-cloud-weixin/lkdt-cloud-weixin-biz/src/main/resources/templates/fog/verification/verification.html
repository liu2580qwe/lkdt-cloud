<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<meta charset="utf-8">
<head th:include="system/user/include :: header"></head>
<head>
	<link href="/lkdtWX/js/plugins/range/jquery.range.css" rel="stylesheet"/>
	<style type="text/css">
		.guicss{display: block;}
		ins {
			background-color: unset;
		}
	</style>
</head>
<body class="gray-bg">
	<div class="wrapper wrapper-content ">
		<div class="row">
			<div class="col-sm-6" id="video">
				<!-- <img alt="" src="/fog/ceshi.png" style="width: 100%">  -->
				<div class="ggcontainer" id="crop-avatar">
                            <form class="avatar-form" action="/sys/user/uploadImg" enctype="multipart/form-data" method="post">
                                <div class="avatar-body">
                                     <div class="avatar-upload">
                                        <input class="avatar-src" name="avatar_src" type="hidden">
                                        <input class="avatar-data" name="avatar_data" type="hidden">
                                        <label for="avatarInput">选取文件</label>
                                        <input class="avatar-input" id="avatarInput" name="avatar_file" type="file">
                                    </div> 
                                    <!-- Crop and preview -->
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="avatar-wrapper"></div>
                                        </div>
                                    </div>

                                    <div class="row ">
                                        <div class="col-md-9">
                                            <div class="btn-group avatar-btns">
                                                <button class="btn btn-primary" data-method="getHeight" data-option="w1" type="button">w1</button>
                                                <button class="btn btn-primary" data-method="getHeight" data-option="w2" type="button" style="margin: 0px 2px">w2</button>
                                                <button class="btn btn-primary" data-method="getHeight" data-option="y1" type="button" style="margin: 0px 2px">Y1</button>
                                                <button class="btn btn-primary" data-method="getHeight" data-option="y2" type="button" style="margin: 0px 2px">Y2</button>
                                                <button class="btn btn-primary" data-method="getHeight" data-option="y4" type="button" style="margin: 0px 2px">Yc</button>
                                                <button class="btn btn-primary" data-method="getHeight" data-option="ymax" type="button" style="margin: 0px 2px">Ymax</button>
                                                <button class="btn btn-primary" data-method="getHeight" data-option="sbx" type="button" style="margin: 0px 2px">上边线</button>
                                                <button class="btn btn-primary" data-method="getHeight" data-option="xbx" type="button" style="margin: 0px 2px">下边线</button>
                                            </div>
                                        </div>
                                        <div class="col-md-3" style="margin-top: 30px; margin-bottom: 15px;">
                                            <button class="btn btn-primary" style="margin: 0px 2px" onclick="pianli()" type="button" >辅助线</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <!-- Loading state -->
                            <div class="loading" aria-label="Loading" role="img" tabindex="-1"></div>
                        </div>
				
			</div>
			<div class="col-sm-6">
				<div class="ibox float-e-margins">
					
					<div class="ibox-content">
						<div style="text-align: center;margin-bottom: 10px;">
							<label class="" style="font-size: 19px;" th:text="${camera.equName}"></label><label style="font-size: 19px;">白天建模</label>
						</div>
						<form class="form-horizontal m-t" id="f1" name="f1" action="" method ="post">
							<input id="epId" name="epId" th:value="${camera.epId}"  type="hidden">
							<input id="userId" name="userId" type="hidden">
							
							<div class="form-group guicss" >
								<label class="col-sm-3 control-label">w1：</label>
								<div class="col-sm-3">
									<input id="w1" name="w1" class="form-control" type="text" th:value="${verification?.w1}">
								</div>
								<label class="col-sm-3 control-label">w2：</label>
								<div class="col-sm-3">
									<input id="w2" name="w2" class="form-control" type="text" th:value="${verification?.w2}">
								</div>
							</div>
							
							<div class="form-group guicss" >
								<label class="col-sm-3 control-label">d：</label>
								<div class="col-sm-3">
									<input id="d" name="d" class="form-control" type="text" th:value="${verification?.d}">
								</div>
								
								<label class="col-sm-3 control-label">z1：</label>
								<div class="col-sm-3">
									<input id="z1" name="z1" class="form-control btn-warning" type="text" th:value="${verification?.z1}">
								</div>
							</div>
							
							
							<div class="form-group guicss" >
								<label class="col-sm-3 control-label">y1：</label>
								<div class="col-sm-3">
									<input id="y1" name="y1" class="form-control" type="text" th:value="${verification?.y1}">
								</div>
								<label class="col-sm-3 control-label">y2：</label>
								<div class="col-sm-3">
									<input id="y2" name="y2" class="form-control" th:value="${verification?.y2}"
										type="text">
								</div>
							</div>
							<div class="form-group guicss" >
								<label class="col-sm-3 control-label">Yc：</label>
								<div class="col-sm-3">
									<input id="y4" name="y4" class="form-control" th:value="${verification?.y4}"
										type="text">
								</div>
							</div>
								<div class="form-group guicss" >
								<label class="col-sm-3 control-label">y<sub>max</sub>：</label>
								<div class="col-sm-3">
									<input id="ymax" name="ymax" class="form-control" th:value="${verification?.ymax}"
										type="text">
								</div>
							</div>
							<div class="form-group guicss" >
								<label class="col-sm-3 control-label">摄像杆高度(m) H：</label>
								<div class="col-sm-3">
									<input id="H" name="H" class="form-control" th:value="${verification?.H}"
										type="text">
								</div> 
								
							</div>
							<div class="form-group guicss" >
								<label class="col-sm-3 control-label">上边线：</label>
								<div class="col-sm-3">
									<input id="sbx" name="sbx" class="form-control" type="text">
								</div>
								<label class="col-sm-3 control-label">下边线：</label>
								<div class="col-sm-3">
									<input id="xbx" name="xbx" class="form-control" type="text">
								</div>
								<input id="calborder" name="calborder" type="hidden">
							</div>
							<div class="form-group guicss" >
								<label class="col-sm-3 control-label">白天系数：</label>
								<div class="col-sm-3">
									<input id="dayx" name="dayx" class="form-control" th:value="${verification?.dayx}"
										type="text">
								</div> 
								
								<label class="col-sm-3 control-label">晚上系数：</label>
								<div class="col-sm-3">
									<input id="nightx" name="nightx" class="form-control" th:value="${verification?.nightx}"
										type="text" style="width: 60%;display: inline;">
									<a class="btn btn-success btn-sm " onclick="editX()" data-index="9999" title="修改系数"  href="#" ><i class="fa fa-check-square" style=""></i></a>
								</div>
							</div>
							<br>
							<!--<div class="form-group">
								<label class="col-sm-3 control-label">清晰度：</label>
								<div class="col-sm-9">
									<input type="hidden" class="single-slider3" value="15"/>
									<input type="number" name="clarity" class="ipgs" value="15" hidden>
								</div>
							</div>-->
							<br>
							<div class="form-group">
								<label class="col-sm-11 control-label" style="text-align: center;">拟合公式:     <span style="display: none">y = (a + Z) / (b + cZ)</span> Z = f(y)
									<button type="button" class="btn btn-primary" onclick="verificationBtn()">计算</button>
									<button type="button" class="btn btn-primary" onclick="save()">保存</button>
								</label>
							</div>
							<div class="form-group">
								<label class="col-sm-3 control-label">计算结果</label>
								<div class="col-sm-8">
									
								</div>
							</div>
							<div class="form-group guicss" >
								<label class="col-sm-2 control-label">a=</label>
								<div class="col-sm-4">
									<input id="a" name="a" class="form-control"  th:value="${verification?.a}"
										type="text">
								</div>
								<label class="col-sm-2 control-label">b=</label>
								<div class="col-sm-4">
									<input id="b" name="b" class="form-control" th:value="${verification?.b}"
										type="text">
								</div>
							</div>
							<div class="form-group  guicss" >
								<label class="col-sm-2 control-label">c=</label>
								<div class="col-sm-4">
									<input id="c" name="c" class="form-control" th:value="${verification?.c}"
										type="text">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-2 control-label">Z<sub>max</sub>=</label>
								<div class="col-sm-4">
									<input id="zmax" name="zmax" class="form-control"  th:value="${verification?.zmax}"
										type="text">
								</div>
							</div>
							
							<div class="form-group">
								<label class="col-sm-3 control-label">可见距离(m)</label>
								<div class="col-sm-8">
									<input id="result" name="visibledist" class="form-control" th:value="${verification?.visibledist}"
										type="text">
									<input id="resultn" name="visibledistn" class="form-control" th:value="${verification?.visibledistn}"
										type="hidden">
									<input id="resultf" name="visibledistf" class="form-control" th:value="${verification?.visibledistf}"
										type="hidden">
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

	</div>
	<script type="text/javascript" src="/lkdtWX/js/jquery.min.js" ></script>
	<script type="text/javascript" src="/lkdtWX/js/bootstrap.min.js" ></script>
	<script type="text/javascript" src="/lkdtWX/js/appjs/fog/verification/verification.js" ></script>
	<script type="text/javascript" src="/lkdtWX/js/plugins/iCheck/icheck.min.js"></script>
	<script type="text/javascript" src="/lkdtWX/js/plugins/cropper/cropper.min.js"></script>
	<script type="text/javascript" src="/lkdtWX/js/plugins/layer/laydate/laydate.js" ></script>
	<script type="text/javascript" src="/lkdtWX/js/plugins/distpicker/distpicker.data.min.js"></script>
	<script type="text/javascript" src="/lkdtWX/js/plugins/distpicker/distpicker.min.js"></script>
	<!--校验插件-->
	<script src="/lkdtWX/js/plugins/layer/layer.js"></script>
	<script src="/lkdtWX/js/plugins/range/jquery.range.js"></script>
	<!--summernote-->
	<script type="text/javascript">
	var mp4url='';
	var cv = null;
	function verificationBtn() {
		var naturalHeight = cv.getMaxHeight();
		doVerification(naturalHeight);
		//$(".avatar-wrapper").html('<video src="' + mp4url + '" autoplay="autoplay"></video>');
		/* $.ajax({
		       type: "post",
		       url: "/fog/vef/save",
		       data: $('#f1').serialize(),
		   }).success(function(message) {
		     console.log(message)
		   }).fail(function(err){
		     console.log(err)
		   }) */
	}
	function save() {
		$("#calborder").val($("#sbx").val()+';'+$("#xbx").val());
		$.ajax({
		       type: "post",
		       url: "/fog/vef/save",
		       data: $('#f1').serialize(),
		   }).success(function(data) {
					parent.layer.msg("操作成功");
					//parent.reLoad();
					var ucrIframe = $(window.parent.document).find("iframe[src='/system/equipment/equipmentver']")[0].contentWindow;;
					ucrIframe.reLoad();
					var index = parent.layer.getFrameIndex(window.name); // 获取窗口索引
					parent.layer.close(index);
		   }).fail(function(err){
		     console.log(err)
		   })
	}
	function editX() {
		var dayx = $("#dayx").val();
		var nightx = $("#nightx").val();
		var epId = $("#epId").val();
		
		$.ajax({
		       type: "post",
		       url: "/fog/vef/save",
		       data: {epId:epId,dayx:dayx,nightx:nightx},
		   }).success(function(message) {
		     console.log(message)
		   }).fail(function(err){
		     console.log(err)
		   })
	}
	</script>
	
			<script type="text/javascript">
			var videoObject = {
				container: '#video', //容器的ID或className
				variable: 'player',//播放函数名称
				video: [//视频地址列表形式
					['http://faing.com:8081/shipin/ceshi-night3-1.mp4', 'video/mp4', '中文标清', 0]
				]
			};
		//	var player = new ckplayer(videoObject);
		</script>
		<script type="text/javascript">
		
		/*this file is used for the bootdo project, it is a unique js file*/
		
		var imgurl='';
	
		$(function(){


			  function CropAvatar($element) {
			    this.$ggcontainer = $element;
			    this.$loading = this.$ggcontainer.find('.loading');
				
			    this.$avatarForm = this.$ggcontainer.find('.avatar-form');
			    this.$avatar = this.$avatarForm.find('img');
			    this.$avatarUpload = this.$avatarForm.find('.avatar-upload');
			    this.$avatarSrc = this.$avatarForm.find('.avatar-src');
			    this.$avatarData = this.$avatarForm.find('.avatar-data');
			    this.$avatarInput = this.$avatarForm.find('.avatar-input');
			    this.$avatarSave = this.$avatarForm.find('.avatar-save');
			    this.$avatarBtns = this.$avatarForm.find('.avatar-btns');
			    this.$cosB = $("#cosBtn");

			    this.$avatarWrapper = this.$avatarForm.find('.avatar-wrapper');

			    this.init();
			   
			  }

			  CropAvatar.prototype = {
			    constructor: CropAvatar,

			    support: {
			      fileList: !!$('<input type="file">').prop('files'),
			      blobURLs: !!window.URL && URL.createObjectURL,
			      formData: !!window.FormData
			    },

			    init: function () {
			      this.support.datauri = this.support.fileList && this.support.blobURLs;

			      if (!this.support.formData) {
			        this.initIframe();
			      }

			      this.addListener();
			      var qcamera;
			      var epid=$("#epId").val();
			      if('[[${verification?.calborder}]]'!=''){
			    	  var calborder='[[${verification?.calborder}]]';
			    	  $("#sbx").val(calborder.split(";")[0]);
			    	  $("#xbx").val(calborder.split(";")[1]);
			    	  
				   }
			      if('['+'[${fog.ip}]'+']'=='0.0.0.0'){
					   mp4url='/files/verification'+'['+'[${fog.rtsp}]'+']';
					   //this.url='/fog/vef/getvalimg/'+epid+'?'+(new Date()).getTime();
					   //imgurl='/fog/vef/getvalimg/'+epid+'?'+(new Date()).getTime();
					   this.url='/files/verification/'+epid+'.png?'+(new Date()).getTime();
					   imgurl='/files/verification/'+epid+'.png?'+(new Date()).getTime();
					   this.startCropper();
				   }
			     
			    },

			    addListener: function () {
			      this.$avatarInput.on('change', $.proxy(this.change, this));
			      this.$avatarForm.on('submit', $.proxy(this.submit, this));
			      this.$avatarBtns.on('click', $.proxy(this.getHeight, this));
			      this.$cosB.on('click', $.proxy(this.cosB, this));
			    },
			    
			    initPreview: function () {
			      var url = this.$avatar.attr('src');

			    },

			    initIframe: function () {
			      var target = 'upload-iframe-' + (new Date()).getTime(),
			          $iframe = $('<iframe>').attr({
			            name: target,
			            src: ''
			          }),
			          _this = this;

			      // Ready ifrmae
			      $iframe.one('load', function () {

			        // respond response
			        $iframe.on('load', function () {
			          var data;

			          try {
			            data = $(this).contents().find('body').text();
			          } catch (e) {
			          }

			          if (data) {
			            try {
			              data = $.parseJSON(data);
			            } catch (e) {
			            }

			            _this.submitDone(data);
			          } else {
			            _this.submitFail('Image upload failed!');
			          }

			          _this.submitEnd();

			        });
			      });

			      this.$iframe = $iframe;
			      this.$avatarForm.attr('target', target).after($iframe.hide());
			    },
			    
			    change: function () {
			      var files,
			          file;

			      if (this.support.datauri) {
			        files = this.$avatarInput.prop('files');

			        if (files.length > 0) {
			          file = files[0];

			          if (this.isImageFile(file)) {
			            if (this.url) {
			              URL.revokeObjectURL(this.url);// Revoke the old one
			            }

			            this.url = URL.createObjectURL(file);
			            imgurl= URL.createObjectURL(file);
			            this.startCropper();
			          }
			        }
			      } else {
			        file = this.$avatarInput.val();

			        if (this.isImageFile(file)) {
			          this.syncUpload();
			        }
			      }
			    },

			    submit: function () {
			      if (!this.$avatarSrc.val() && !this.$avatarInput.val()) {
			        return false;
			      }

			      if (this.support.formData) {
			        this.ajaxUpload();
			        return false;
			      }
			    },
			    getHeight: function(e) {
			    	   var data;
				      if (this.active) {
				        data = $(e.target).data();
				        var option = data.option;
				        var v = this.$img.cropper("getData");
				        if (option == 'x') {
				        	$("#"+option).val(v.width);
				        } else if (option == 'w1' || option == 'w2') {
				        	$("#"+option).val(v.width);
				        }else if(option == 'sbx'){
				        	$("#"+option).val(v.x+','+v.y+';'+(v.x+v.width)+','+v.y);
				        }else if(option == 'xbx'){
				        	$("#"+option).val(v.x+','+v.y+';'+(v.x+v.width)+','+v.y);
				        }else {
				        
				        	$("#"+option).val(v.height);	
				        }
				        
				      }
			    },
			    
			    getMaxHeight: function() {
				      if (this.active) {
				        var v = this.$img.cropper("getImageData");
				        return v.naturalHeight;
				      }
			    },
			    cosB:function (e) {
			    	var data;
				      if (this.active) {
				        data = $(e.target).data();
				        var v = this.$img.cropper("getData");
				        var c = Math.sqrt(v.width*v.width + v.height*v.height);
				        var cos = v.height/c;
				        $("#cosB").val(cos);
				      }
				   return;
			    },
			    rotate: function (e) {
			      var data;

			      if (this.active) {
			        data = $(e.target).data();

			        if (data.method) {
			          this.$img.cropper(data.method, data.option);
			        }
			      }
			    },

			    isImageFile: function (file) {
			      if (file.type) {
			        return /^image\/\w+$/.test(file.type);
			      } else {
			        return /\.(jpg|jpeg|png|gif)$/.test(file);
			      }
			    },

			    startCropper: function () {
			      var _this = this;
			      if (this.active) {
			        this.$img.cropper('replace', this.url);
			      } else {
			        this.$img = $('<img src="' + this.url + '">');
			        this.$avatarWrapper.empty().html(this.$img);
			        this.$img.cropper({
			          aspectRatio: NaN,
			          strict: true,
			          crop: function (data) {
			              
			          }
			        });

			        this.active = true;
			      }
			    },

			    stopCropper: function () {
			      if (this.active) {
			        this.$img.cropper('destroy');
			        this.$img.remove();
			        this.active = false;
			      }
			    },

			    ajaxUpload: function () {
			      var url = this.$avatarForm.attr('action'),
			          data = new FormData(this.$avatarForm[0]),
			          _this = this;

			      $.ajax(url, {
			        type: 'post',
			        data: data,
			        dataType: 'json',
			        processData: false,
			        contentType: false,

			        beforeSend: function () {
			          _this.submitStart();
			        },

			        success: function (data) {
			          _this.submitDone(data);
			        },

			        error: function (XMLHttpRequest, textStatus, errorThrown) {
			          _this.submitFail(textStatus || errorThrown);
			        },

			        complete: function () {
			          _this.submitEnd();
			        }
			      });
			    },

			    syncUpload: function () {
			      this.$avatarSave.click();
			    },

			    submitStart: function () {
			      this.$loading.fadeIn();
			    },

			    submitDone: function (data) {

			      if ($.isPlainObject(data) && data.code === 0) {
			        if (data.url) {
			          this.url = data.url;

			          if (this.support.datauri || this.uploaded) {
			            this.uploaded = false;
			            this.cropDone();
			          } else {
			            this.uploaded = true;
			            this.$avatarSrc.val(this.url);
			            this.startCropper();
			          }

			          this.$avatarInput.val('');
			          this.alert(1,data.msg);
			        } else if (data.msg) {
			          this.alert(2,data.msg);
			        }
			      } else {
			        this.alert(2,'Failed to response');
			      }
			    },

			    submitFail: function (msg) {
			      this.alert(2,msg);
			    },

			    submitEnd: function () {
			      this.$loading.fadeOut();
			    },

			    cropDone: function () {
			      this.$avatarForm.get(0).reset();
			      this.$avatar.attr('src', this.url);
			      this.stopCropper();
			    },

			    alert: function (code,msg) {
			        var alertClass="";
			      if(code==1){
			        alertClass="alert-success";
			      }else if(code==2){
			          alertClass="alert-danger";
			      }
			      var $alert = [
			            '<div class="alert '+alertClass+' avater-alert">',
			              '<button type="button" class="close" data-dismiss="alert">&times;</button>',
			              msg,
			            '</div>'
			          ].join('');

			      this.$avatarUpload.after($alert);
			    }
			  };

			  $(function () {
			    cv =  new CropAvatar($('#crop-avatar'));
			  });

			
		});
		/*头像裁剪*/


		function pianli() {
			layer.open({
				type : 2,
				title : '增加',
				maxmin : true,
				shadeClose : false, // 点击遮罩关闭层
				area : [ '800px', '520px' ],
				//content : '/fog/vef/offset?path='+$("#epId").val()+'.png'
				content : '/fog/vef/offset?path='+imgurl+"&epId="+$("#epId").val()
			});
		}
		
		function reLoad(pth) {
			$(".avatar-wrapper img").attr("src", pth);
		}

		// let clarity;
		// //ip个数
		// clarity = $('.single-slider3').jRange({
		// 	//滑块滑动时 触发的函数
		// 	onstatechange: function () {
		// 		$('.ipgs').val($('.single-slider3').val());
		// 	},
		// 	from: 10,//最小值
		// 	to: 18,//最大值
		// 	step: 0.02,//步进
		// 	//这里改变值
		// 	scale: [10,11,12,13,14,15,16,17,18],
		// 	format: '%s',
		// 	width: 350,//总宽度
		// 	showLabels: true,
		// 	showScale: true
		// });
		// $(".ipgs").blur(function () {
		// 	test.setValue( $(this).val());//能绑定滑块的变化
		// });
		</script>
</body>
</html>
