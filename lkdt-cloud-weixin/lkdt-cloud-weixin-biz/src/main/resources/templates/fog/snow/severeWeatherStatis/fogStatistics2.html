<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head th:include="include :: header"></head>


<style>
    body{
        min-width: 950px;
    }

    .clear{clear:both;}

    .search-span{
        height: 60px;
        padding: 10px 10px;
        display: -webkit-inline-box;
    }

    ul li {
        list-style: none;
    }

    .alarmEquList{
        border: 1px solid #eee;
    }

    .alarmEquList ul{
        list-style: none;
        padding: 0px;
        margin: 0px;
        width: 100%;
        height: 35px;
        line-height: 35px;
        border-width: 1px;
        border-color: #063B6A;
        border-style: none none dashed none;
        border-top: 0px;
        font-size: 16px;
        color: #fff;
    }

    .alarmEquList li{
        display: block;
        width: 18%;
        margin-left:1%;
        float: left;
        text-align: center;
        text-overflow:ellipsis;
        white-space:nowrap;
        overflow:hidden;
    }

    .alarmEquList .njd{
        width: 18%;
    }

    .alarmEquList .kssj{
        width: 16%;
    }

    .alarmEquList .cxsj{
        width: 25%;
    }

    .li_color{
        color: #95C1EE;
    }

    .wumai_light_red{
        background:url("/lkdtWX/img/wumai_light_red.gif");
        background-size:100%;
        height:20px;
        width:20px;
    }

    .wumai_orange{
        background:url("/lkdtWX/img/wumai_orange.gif");
        background-size:100%;
        height:20px;
        width:20px;
    }

    .wumai_red{
        background:url("/lkdtWX/img/wumai_red.gif");
        background-size:100%;
        height:20px;
        width:20px;
    }

    .wumai_yellow{
        background:url("/lkdtWX/img/wumai_yellow.gif");
        background-size:100%;
        height:20px;
        width:20px;
    }

    .nofog{
        background:url("/lkdtWX/plugins/weui/img/wumai_nofog.png");
        background-size:100%;
        height:20px;
        width:20px;
    }


    .track-rcol {
        border: 1px solid #eee;
    }

    .track-list {
        position: relative;
    }

    .track-list h2{
        margin: 20px;
    }

    .track-list li {
        position: relative;
        padding-left: 25px;
        height: 2.5vw;
        line-height: 2.5vw;
        border-left: 1px solid #d9d9d9;
        color: #eee;
        font-size: 1.5vw;
    }

    .track-list li.first {
        color: red;
        padding-top: 0;
        border-left-color: #fff;
    }

    .track-list li .node-icon {
        position: absolute;
        left: -6px;
        top: 50%;
        width: 11px;
        height: 11px;
        background: #95C1EE;
        border-radius:10px;
    }

    .track-list li .node-div{
        /* 		text-overflow:ellipsis;  */
        white-space:nowrap;
        /* 		overflow:hidden; */
    }

    .track-list li.first .node-icon {
        background-position: 0 -72px;
    }

    .track-list li .time {
        margin-right: 15px;
        position: relative;
        top: 4px;
        display: inline-block;
        vertical-align: middle;
    }

    .track-list li .txt {
        position: relative;
        top: 4px;
        display: inline-block;
        vertical-align: middle;
    }

    .track-list li.first .time {
        margin-right: 20px;
    }

    .track-list li.first .txt {
        max-width: 600px;
    }

    .track-list .txt .gaojing{
        color: red;
    }

    .track-list .txt .huisheng{
        color: #ffeb3b;
    }

    .track-list .txt .jiechu{
        color: #48ef8b;
    }

    #alarmCalendar .laydate-day-mark::after{
        background-color:transparent;
    }

</style>

<body class="gray-bg" style="overflow-x: auto;background-size:150% 200%;">
<input id="hwId" th:value="${hwId}" type="hidden">
<input id="hwIds" th:value="${hwIds}" type="hidden">
<input id="alarmDate" th:value="${alarmDate}" type="hidden">

<div class="">
    <div class="col-sm-12" style="padding-left: 10px; padding-right: 10px;">
        <div class="">
            <div class="ibox-body">

                <div id="info" style="width: 100%; margin-top: 5px;" >
                    <input id="liveAddress" style="height: calc(100%);" th:value="${liveAddress}" hidden/>
                    <div id="alarmCalendar" style="width: 50%;height: 410px;float: left;"></div>
                    <div id="allmap" style="width: 50%;height: 410px;float: right;"></div>
                    <div class="clear"></div>

                    <div id="alarmEquList" class="alarmEquList" style="width: 50%;height: 275px;float: left;margin-top: 15px;margin-bottom: 15px;" >
                        <ul style="border-bottom: 1px solid #eee">
                            <li>路段</li>
                            <li>编号</li>
                            <li class="njd">能见度(米)</li>
                            <li class="kssj">开始时间</li>
                            <li class="cxsj">持续时长</li>
                        </ul>
                        <ul id="contentUl" style="height: 240px;overflow:auto;">
                            <li>-</li>
                            <li>-</li>
                            <li>-</li>
                            <li>-</li>
                            <li>-</li>
                        </ul>
                    </div>

                    <div class="track-rcol" style="width: 50%;height: 275px;float: right;margin-top: 15px;margin-bottom: 15px;">
                        <div id="roadColse_d" class="track-list">
                            <h2 id='colseTitle'>起雾与封路时间线</h2>
                            <div id="roadColse" class="track-list"></div>
                        </div>
                    </div>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:include="include :: footer"></div>

<!-- 时间控件 -->
<script	src="/lkdtWX/js/plugins/laydate/laydate.js"></script>
<!-- echarts -->
<script src="/lkdtWX/js/plugins/echarts/echarts.min.js"></script>
<!-- 高德地图 -->
<script language="javascript" src="https://webapi.amap.com/maps?v=1.4.14&key=0fb99186996b7bff85d606c80d16f224&plugin=Map3D,AMap.DistrictSearch"></script>
<!-- UI组件库 1.0 -->
<script type="text/javascript" src="https://webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
<!-- 地图数据展示 -->
<script	src="/fog/alarm/alarmMap.js?v=1.1.1&date=20201201"></script>

<script type="text/javascript">
    let map = null;

    $(function () {
        let hwId = $("#hwId").val();
        let hwIds = $("#hwIds").val();
        let alarmDate = $("#alarmDate").val();

        //初始化告警日历
        initCalendar(hwId,hwIds,alarmDate);

        //初始化告警摄像头列表
        initEquAlarm(hwId,hwIds,alarmDate);
    });

    //监听窗口大小变化
    $(window).resize(function() {
        //JS计算控件的宽度
        setLaydateWidth();
    })

    /***************** 日历 start *************************/
    function initCalendar(hwId,hwIds,alarmDate){
        $.ajax({
            type : 'get',
            url : '/report/alarmReport/queryCalendarAlarm',
            data:{'hwId':hwId,'hwIds':hwIds},
            success : function(cList) {
                let oMark = {};
                let nextDate = "";
                let sdate = ""; //记录时间
                let date_day = ""; //取日期的天比如2017-09-11取11
                let data_style = "";
                let left_value = 12;
                for(let i = 0; i < cList.length; i++){
                    sdate = cList[i].statisticsDate; //记录时间

                    if(i == 0){
                        nextDate = sdate ;
                        date_day = sdate.split("-")[2]; //取日期的天比如2017-09-11取11
                        data_style = '<span style="color:#666;font-size: 14px;">';

                        data_style += getMarkStyle(left_value,cList[i].alarmLevel,cList[i].statisticsNum);

                        if(cList.length == 1){
                            data_style += date_day + '</span>';
                            oMark[nextDate] = data_style;
                        }
                    }else if(i > 0 && i <= cList.length-1){
                        if(nextDate != sdate){
                            data_style += date_day + '</span>';
                            oMark[nextDate] = data_style;

                            nextDate = sdate ;
                            left_value = 12;
                            date_day = sdate.split("-")[2]; //取日期的天比如2017-09-11取11
                            data_style = '<span class="item_day" style="color:#666;font-size: 14px;display:block;">';

                            data_style += getMarkStyle(left_value,cList[i].alarmLevel,cList[i].statisticsNum);
                        }else{
                            data_style += getMarkStyle(left_value,cList[i].alarmLevel,cList[i].statisticsNum);
                        }

                        if(i == cList.length-1){
                            data_style += date_day + '</span>';
                            oMark[nextDate] = data_style;
                        }
                    }
                    left_value += 24;
// 			        oMark[sdate] = '<span style="color:#666;font-size: 14px;"><i class="iconfont icon-rizhi" style="color:#fff; position:absolute; left: 5px;bottom:3px;font-size: 13px;display:block;width:16px;height:16px;line-height:16px;border-radius:10px;">'+cList[i].statisticsNum+'</i>' + date_day + '</span>';;
                }

                laydate.render({
                    elem: '#alarmCalendar',
                    value:alarmDate,
                    position: 'static',
                    calendar: false,	//true 属性代表，展示公历的节假日（例如圣诞，元旦。。。）
                    theme: 'molv',
                    btns: ['now'],
                    mark: oMark,
                    done: function(value, date) {		//控件选择完毕后的回调---点击日期、清空、现在、确定均会触发。
                        initEquAlarm(hwId,hwIds,value);
                    },
                    change: function(value, date, endDate){//日期时间被切换后的回调
                        setLaydateWidth();
                    },
                    ready:function(date){	//控件在打开时触发，回调返回一个参数
                        setLaydateWidth();
                    }
                });


            }
        });
    }

    function getMarkStyle(left_value,alarmLevel,statisticsNum){
        let data_style = '<i class="iconfont icon-rizhi" style="color:#fff; position:absolute;bottom:3px;font-size: 13px;display:block;width:16px;height:16px;line-height:16px;border-radius:10px;';
        data_style += 'left: '+left_value+'px;';
        if(alarmLevel == "4"){	//特级
            data_style += 'background:#9a1200;">';
        }else if(alarmLevel == "3"){	//一级
            data_style += 'background:#d81e06;">';
        }else if(alarmLevel == "2"){	//二级
            data_style += 'background:#ffa500;">';
        }else if(alarmLevel == "1"){	//三级
            data_style += 'background:#f4ea2a;">';
        }
        data_style += statisticsNum+'</i>' ;
        return data_style;
    }

    //JS计算控件的宽度
    function setLaydateWidth(){
        let bWidth = $(document.body).width();
        let acWidth = (bWidth-40)*0.5 ;
        let sWidth = acWidth/7 ;
        $("#alarmCalendar").css("width",acWidth+"px");	//日历
        $("#alarmEquList").css("width",acWidth+"px");	//摄像头列表
        $("#alarmCalendar .layui-laydate-main").css("width","100%");
        $("#alarmCalendar .layui-laydate-content td,#test-n1 .layui-laydate-content th").css("width",sWidth+"px");
        $("#alarmCalendar .layui-laydate-content td,#test-n1 .layui-laydate-content th").css("height","45.1px");


        $(".laydate-day-mark").children("span").each(function(){
            let ilength = $(this).children("i").length;
            let leftWidth = (sWidth - (ilength * 16)) / (ilength+1);
            let lw = leftWidth;
            $(this).children("i").each(function(){
                $(this).css("left",lw+"px");
                lw += 16+leftWidth;
            });
        });
    }
    /***************** 日历 end *************************/

    /*********告警摄像头列表 start ****************/
    function initEquAlarm(hwId,hwIds,alarmDate){
        $.ajax({
            type : 'get',
            url : '/report/alarmReport/queryEquAlarm',
            data:{'hwId':hwId,'hwIds':hwIds,'alarmDate':alarmDate},
            success : function(dataAll) {
                let data = dataAll.equAlarm;
                let html = "";
                for (let i = 0; i < data.length; i++) {
                    html += "<ul>";
                    let param__ = null;
                    if(data[i].lon && data[i].lat){
                        param__= data[i].lon+","+data[i].lat;
                    } else {
                        param__= "-1,-1";
                    }

                    html += "<li class='li_color' ><a href='###' style='color: #95C1EE;' " +
                        "title='" +data[i].hwName + "' onclick='showRoadClose(\""+data[i].roadAlarmId+"\")'>" +
                        data[i].hwName+ "</a></li>";
                    html += "<li class='li_color' ><a href='###' style='color: #95C1EE;' " +
                        "title='" +data[i].epId+"："+data[i].equName + "' onclick='"+"locationFunc("+param__+")"+"'>" +
                        data[i].equName+ "</a></li>";
                    if(data[i].distance == -1){
                        html += "<li class='njd'>" + "异常设备</li>";
                    }else{
                        html += "<li class='njd'>" + data[i].distance + "(m)</li>";
                    }
                    let begintime = data[i].begintime.substring(10);
                    html += "<li class='kssj' title='" + data[i].begintime + "'>" + (begintime==''?'&nbsp;':begintime) + "</li>";
                    html += "<li class='cxsj'><a href='###' style='color: #95C1EE;' " +
                        "title='" +toHourMinute(data[i].forMinute)+ "' onclick='openFog(\""+data[i].epId+"\",\""+data[i].equName+"\",\""+data[i].hwName+"\",\""+data[i].begintime+"\",\""+data[i].endtime+"\")'>" +
                        toHourMinute(data[i].forMinute)+ "</a></li>";
                    html += "</ul>";
                }
                $("#contentUl").html(html);

                //地图
                mapInit(data,"allmap","fog");

                if(data.length > 0){
                    //封路
                    showRoadClose(data[0].roadAlarmId);
                }else{
                    //封路
                    showRoadClose("");
                }

            }
        });
    }

    /**将分钟数量转换为小时和分钟**/
    function toHourMinute(minutes){
        if(minutes === "" || minutes == null){
            return "未结束";
        }
        if(!isNaN(minutes)){
            return (Math.floor(minutes/60) + "小时" + (minutes%60) + "分" );
        }else{
            return "未结束";
        }
    }

    /**
     * 警告列表摄像头定位
     * */
    function locationFunc(lon,lat){
        //异常
        if(lon == -1 || lat == -1){
            layer.msg("ERROR403·经纬度异常");
            return;
        }
        let point = new AMap.LngLat(lon, lat);
        map.setZoom(14);  // 初始化地图,设置中心点坐标和地图级别
        map.setCenter(point);
    }

    function openFog(epId,epName,hwName,beginTime,endTime){
        layer.open({
            type : 2,
            title : "ID："+epId+" >> 桩号："+epName+" >> 位置："+hwName,
            maxmin : true,
            shadeClose : false, // 点击遮罩关闭层
            area : [ '75%', '100%' ],
            zIndex:99999999,
// 	        content : '/report/alarmReport/alarmEquipment?epId='+epId+'&epName='+epName+'&hwName='+hwName+'&beginTime='+beginTime+'&endTime='+endTime
            content : '/report/alarmReport/alarmEquipment?epId='+epId+'&beginTime='+beginTime+'&endTime='+endTime
        });
    }

    function showRoadClose(roadAlarmId){

        $.ajax({
            type : 'get',
            url : '/report/alarmReport/queryRoadClose',
            data:{'roadAlarmId':roadAlarmId},
            success : function(data) {
                if(data.length == 0){
                    $("#roadColse").html("");
                    $("#colseTitle").html("起雾与封路时间线");
                }
                let rcHtml = "";
                let lastAlarmLevel = -1;
                if(data.length > 0){
                    rcHtml += "<ul style='height: 205px;overflow:auto;'>";
                }
                for (let i = 0; i < data.length; i++) {
                    rcHtml += "<li>";
                    rcHtml += "<i class='node-icon'></i>";
                    rcHtml += "<div class='node-div'>";
                    rcHtml += "<span class='time'>"+data[i].startDate.substring(0,data[i].startDate.length-3)+"</span>";
                    if(data[i].alarmLevel != '99'){
                        rcHtml += "<span class='txt'>"+showMessage(data[i].mindistanceNow,data[i].alarmLevel,lastAlarmLevel)+"</span>";
                        lastAlarmLevel = data[i].alarmLevel;
                        $("#colseTitle").html("起雾与封路时间线（"+data[i].roadname+"）");
                    }else{
                        rcHtml += "<span class='txt'>"+data[i].tsname+"收费站往"+data[i].direction+"方向"+data[i].io+"关闭，关闭时间至"+data[i].endDate.substring(0,data[i].endDate.length-3)+"</span>";
                    }
                    rcHtml += "</div>";
                    rcHtml += "</li>";
                    if(i == data.length-1 ){
                        rcHtml += "</ul>";
                    }
                }
                $("#roadColse").html(rcHtml);
            }
        });
    }

    function showMessage(mindistanceNow,alarmLevel,lastAlarmLevel){
        if(lastAlarmLevel == -1){
            return "发生<span class='gaojing'>"+showLevenDesc(alarmLevel)+"</span>，可视距离"+mindistanceNow+"米";
        }else{
            if(lastAlarmLevel > alarmLevel){	//等级回升
                if(alarmLevel == 1){
                    return "<span class='huisheng'>可视距离回升</span>至"+mindistanceNow+"米";
                }else if(alarmLevel == 0){
                    return "<span class='jiechu'>告警解除</span>，可视距离"+mindistanceNow+"米";
                }else{
                    return "";
                }
            }else{	//等级加重
                return "告警等级提升至<span class='gaojing'>"+showLevenDesc(alarmLevel)+"</span>，可视距离"+mindistanceNow+"米";
            }
        }
    }

    function showLevenDesc(alarmLevel){
        if(alarmLevel == 1){
            return "三级告警";
        }else if(alarmLevel == 2){
            return "二级告警";
        }else if(alarmLevel == 3){
            return "一级告警";
        }else if(alarmLevel == 4){
            return "特级告警";
        }else if(alarmLevel == 0){
            return "告警解除";
        }else{
            return "未知级别";
        }
    }
    /*********告警摄像头列表 end ****************/





</script>

</body>
</html>