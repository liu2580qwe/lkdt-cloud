<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>江苏东部高速公路恶劣天气事件统计</title>
<head th:include="include :: header"></head>
<link href="/lkdtWX/js/plugins/datapicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">

<style>
    .clear{clear:both;}

    .search-span{
        height: 60px;
        padding: 10px 10px;
        display: -webkit-inline-box;
    }

    ul li {
        list-style: none;
    }

    .alarmRoadList{
        border: 1px solid #eee;
    }

    .alarmRoadList ul{
        list-style: none;
        padding: 0px;
        margin: 0px;
        width: 100%;
        height: 35px;
        line-height: 35px;
        border-width: 1px;
        border-color: #063B6A;
        border-style: none none dashed none;
        border-top: 0px;
        font-size: 16px;
        color: #fff;
    }

    .alarmRoadList li{
        display: block;
        width: 15%;
        margin-left:1%;
        float: left;
        text-align: center;
        text-overflow:ellipsis;
        white-space:nowrap;
        overflow:hidden;
    }

    .alarmRoadList .njd{
        /*width: 18%;*/
    }

    .li_color{
        color: #95C1EE;
    }

    .wumai_light_red{
        background:url("/lkdtWX/img/wumai_light_red.gif");
        background-size:100%;
        height:20px;
        width:20px;
    }

    .wumai_orange{
        background:url("/lkdtWX/img/wumai_orange.gif");
        background-size:100%;
        height:20px;
        width:20px;
    }

    .wumai_red{
        background:url("/lkdtWX/img/wumai_red.gif");
        background-size:100%;
        height:20px;
        width:20px;
    }

    .wumai_yellow{
        background:url("/lkdtWX/img/wumai_yellow.gif");
        background-size:100%;
        height:20px;
        width:20px;
    }

    .nofog{
        background:url("/lkdtWX/plugins/weui/img/wumai_nofog.png");
        background-size:100%;
        height:20px;
        width:20px;
    }


    .track-rcol {
        border: 1px solid #eee;
    }

    .track-list {
        position: relative;
    }

    .track-list h2{
        margin: 20px;
    }

    .track-list li {
        position: relative;
        padding-left: 25px;
        height: 2.5vw;
        line-height: 2.5vw;
        border-left: 1px solid #d9d9d9;
        color: #eee;
        font-size: 1.5vw;
    }

    .track-list li.first {
        color: red;
        padding-top: 0;
        border-left-color: #fff;
    }

    .track-list li .node-icon {
        position: absolute;
        left: -6px;
        top: 50%;
        width: 11px;
        height: 11px;
        background: #95C1EE;
        border-radius:10px;
    }

    .track-list li .node-div{
        /* 		text-overflow:ellipsis;  */
        white-space:nowrap;
        /* 		overflow:hidden; */
    }

    .track-list li.first .node-icon {
        background-position: 0 -72px;
    }

    .track-list li .time {
        margin-right: 15px;
        position: relative;
        top: 4px;
        display: inline-block;
        vertical-align: middle;
    }

    .track-list li .txt {
        position: relative;
        top: 4px;
        display: inline-block;
        vertical-align: middle;
    }

    .track-list li.first .time {
        margin-right: 20px;
    }

    .track-list li.first .txt {
        max-width: 600px;
    }

    .track-list .txt .gaojing{
        color: red;
    }

    .track-list .txt .huisheng{
        color: #ffeb3b;
    }

    .track-list .txt .jiechu{
        color: #48ef8b;
    }

    .datetimepicker {
        padding: 4px;
        margin-top: 1px;
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px;
        border-radius: 4px;
        direction: ltr;
        color: black;
    }

    .cDiv {
        -webkit-user-select: none;  /* 禁止 DIV 中的文本被鼠标选中 */
        -moz-user-select: none;     /* 禁止 DIV 中的文本被鼠标选中 */
        -ms-user-select: none;      /* 禁止 DIV 中的文本被鼠标选中 */
        user-select: none;             /* 禁止 DIV 中的文本被鼠标选中 */
    }
    
    .desc{
    	width: 330px;
    	border: 1px dashed #fda20e;
    	padding: 5px 10px;
    	margin: 35px 5px 0px 5px;
    	font-size: 16px;
    }
</style>

<body class="gray-bg" style="min-width: 1460px;overflow-x: auto;background-size:150% 200%;">
<input id="alarmDate" th:value="${alarmDate}" type="hidden">

<div class="">
    <div class="col-sm-12" style="padding-left: 10px; padding-right: 10px;">
        <div class="">
            <div class="ibox-body">

                <div id="info" style="width: 100%; margin-top: 5px;" >
                    <input id="liveAddress" style="height: calc(100%);" th:value="${liveAddress}" hidden/>

					<!-- 左侧统计 -->
                    <div style="width: 50%;height: calc(100% - 20px);min-width: 730px;float: left;margin-top: 10px;">
                    	<!-- 查询条件 -->
                    	<div id="c_div_1" style="width: 100%;height: 52px;">
                    		<!--选择年-->
	                        <div id="selectYear" class="form-group" style="margin-bottom: 0px; width: 50%; float: left;">
	                            <label for="dtp_input_dtp_year" class="col-md-2 control-label" style="line-height: 30px;width: 90px;">记录选择</label>
	                            <div class="input-group date form_date_year col-md-5" style="width:240px;"
	                                 data-date="" data-date-format="yyyy" data-link-field="dtp_input4" data-link-format="yyyy">
	                                <input class="form-control" size="16" type="text" value="" readonly>
	                                <span class="input-group-addon" style="background-color: #009688;"><span class="glyphicon glyphicon-time"></span></span>
	                                <span class="input-group-addon" style="background-color: #009688;"><span class="glyphicon glyphicon-remove"></span></span>
	                            </div>
	                            <input type="hidden" id="dtp_input_dtp_year" value="" /><br/>
	                        </div>
	                        <!--选择年月-->
	                        <div id="selectYearMonth" class="form-group" style="margin-bottom: 0px; width: 50%; float: left;display: none;">
	                            <label for="dtp_input_dtp_year_month" class="col-md-2 control-label" style="line-height: 30px;width: 90px;">记录选择</label>
	                            <div class="input-group date form_date_year_month col-md-5" style="width:240px;"
	                                 data-date="" data-date-format="MM yyyy" data-link-field="dtp_input4" data-link-format="yyyy-mm">
	                                <input class="form-control" size="16" type="text" value="" readonly>
	                                <span class="input-group-addon" style="background-color: #009688;"><span class="glyphicon glyphicon-time"></span></span>
	                                <span class="input-group-addon" style="background-color: #009688;"><span class="glyphicon glyphicon-remove"></span></span>
	                            </div>
	                            <input type="hidden" id="dtp_input_dtp_year_month" value="" /><br/>
	                        </div>
	                        <!--选择省份-->
	                        <!--<div class="form-group">
	                            <label for="dtp_input_province" class="col-md-2 control-label" style="line-height: 30px;">选择省份</label>
	                        </div>-->
	                        <!--选择路段-->
	                        <div class="form-group" style="margin-bottom: 0px; width: 50%; float: left; ">
	                            <label for="dtp_input_road" class="col-md-2 control-label" style="line-height: 30px;width: 90px;">选择路段</label>
	                            <input id="hwId" name="hwId" value="1" class="hidden">
	                            <input id="hwName" name="hwName" class="form-control" type="text"
	                                   style="cursor: pointer;width: 200px; float: left; cursor: not-allowed;" onclick="openHighway()"
	                                   readonly="readonly" placeholder="选择路段" disabled>
	                            <span class="input-group-addon" onclick="clearHwIdAndName()"
	                                  style="background-color: #009688; width: 40px; height: 34px; float: left;line-height: 21px; cursor: pointer; display: none;">
	                                <span class="glyphicon glyphicon-remove" ></span>
	                            </span>
	                            <!--<select class="form-control" style="width:240px; background: #375A6F;">
	                                <option value="1">连云港段</option>
	                                <option value="2">盐城段</option>
	                            </select>-->
	                        </div>
                    	</div>
                    	<div class="clear"></div>
                    	<!-- 图例、说明 -->
                    	<div id="c_div_2" style="width: 100%;height: 143px;">
                    		<div class="form-group" style="float: left; font-size: small; padding: 5px 15px 5px 15px;">
	                            <h4>图例</h4>
	                            <p style="cursor: pointer;" onclick="triggerShack(3)"><span class="cDiv" style="background-color: #ED5565;color: #ED5565;">******</span>&nbsp;雾霾高发路段（三次以上）</p>
	                            <p style="cursor: pointer;" onclick="triggerShack(2)"><span class="cDiv" style="background-color: #EBAC59;color: #EBAC59;">******</span>&nbsp;雾霾易发路段（二次以上）</p>
	                            <p style="cursor: pointer;" onclick="triggerShack(1)"><span class="cDiv" style="background-color: #23C6C8;color: #23C6C8;">******</span>&nbsp;雾霾发生路段（一次以上）</p>
	                        </div>
	                        <div class="form-group" style="float: left; font-size: small; padding: 5px 15px 5px 15px;">
	                            <h3>&nbsp;</h3>
	                            <p style="cursor: pointer;" onclick="triggerShack(3)">&emsp;<span class="cDiv" style="background-color: darkred;color: darkred;border-radius: 25px;">O*</span>&nbsp;&emsp;团雾高发点</p>
	                            <p style="cursor: pointer;" onclick="triggerShack(2)">&emsp;<span class="cDiv" style="background-color: red;color: red;border-radius: 25px;">O*</span>&nbsp;&emsp;团雾易发点</p>
	                            <p style="cursor: pointer;" onclick="triggerShack(1)">&emsp;<span class="cDiv" style="background-color: yellow;color: yellow;border-radius: 25px;">O*</span>&nbsp;&emsp;团雾发生点</p>
	                        </div>
	                        <div class="form-group" style="float: left; font-size: small; padding: 5px 15px 5px 15px;margin-bottom:0px;">
	                        	<div class="desc">
	                            	道路团雾：依据道路交通安全法规和团雾概念，一种强浓雾下局部路段能见度低于<span style="letter-spacing: 1px;">200</span>米且较相临路段更低的道路突发事件。
	                        	</div>
	                        </div>
                    	</div>
                    	<div class="clear"></div>
                    	<!-- 统计 -->
                        <div>
                        	<div style="width: 20%;float: left;">
                        		<h3 id="niandu" style="margin-left: 10px;">2021年度01月</h3>
                        	</div>
                        	<div id="c_div_3" style="width: 60%;height:107px;float: left;">
                        		<h2 style="margin-top: 35px;">江苏东部高速公路恶劣天气事件统计</h2>
			                    <div id="eventType" style="margin-bottom: 15px;">
			                    	<label class="radio-inline">
			                            <input type="radio" name="eventType" id="eventType1" value="option1"  checked> 团雾
			                        </label>
			                        <label class="radio-inline">
			                            <input type="radio" name="eventType" id="eventType2" value="option2" > 低能见度
			                        </label>
			                        <label class="radio-inline">
			                            <input type="radio" name="eventType" id="eventType3" value="option1"  > 冰雪
			                        </label>
			                        <label class="radio-inline">
			                            <input type="radio" name="eventType" id="eventType4" value="option2" > 侧风
			                        </label>
			                    </div>
                        	</div>
                        	<div style="width: 20%;float: left;">
                        		<div style="text-align: right;margin-right: 10%;">
			                        <label class="radio-inline">
			                            <input type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1" onclick="radioFunc()" checked> 按年统计
			                        </label>
			                        <label class="radio-inline">
			                            <input type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2" onclick="radioFunc()"> 按月统计
			                        </label>
			                    </div>
                        	</div>
                        	
		                    <div class="clear"></div>
		                    
		                    
		                    <!-- <div id="eventType" style="width: calc(50% - 10px);height: 54px;font-size: 15px;border: 1px dashed #5ee7fe;padding: 5px 10px;">
		                      	【道路团雾】根据道路交通安全法规和团雾概念，一种强浓雾下局部路段能见度低于200米且较相临路段更低的道路突发事件。
		                    </div> -->
		                    
		                    <div id="alarmRoadList" class="alarmRoadList" style="width: calc(100% - 10px);height: 390px;margin-top: 15px;margin-bottom: 15px;" >
		                        <ul style="border-bottom: 1px solid #eee">
		                            <li>路段</li>
		                            <li>时段</li>
		                            <li>发生次数</li>
		                            <li>影响里程</li>
		                            <li>最低能见度</li>
		                            <li>平均持续时间</li>
		                        </ul>
		                        <ul id="contentUl" style="height: calc(100% - 35px);overflow:auto;">
		                            <li>-</li><li>-</li><li>-</li><li>-</li><li>-</li><li>-</li>
		                        </ul>
		                    </div>
		
		                    <!-- <div class="track-rcol" style="width: 50%;height: 275px;float: right;margin-top: 15px;margin-bottom: 15px;display: none;">
		                        <div id="roadColse_d" class="track-list">
		                            <h2 id='colseTitle'>起雾与封路时间线</h2>
		                            <div id="roadColse" class="track-list"></div>
		                        </div>
		                    </div>
		                    <div class="clear"></div> -->
                        </div>

                        
                    </div>
					<!-- 右侧地图 -->
                    <div id="allmap" style="width: calc(50% - 10px);height: 680px;float: left;"></div>
                    <div class="clear"></div>

                    
                </div>
            </div>
        </div>
    </div>
</div>

<div th:include="include :: footer"></div>
<script src="/lkdtWX/js/plugins/datapicker/bootstrap-datetimepicker.min.js"></script>
<script src="/lkdtWX/js/plugins/datapicker/locales/bootstrap-datetimepicker.zh-CN.js"></script>
<!-- 时间控件 -->
<script	src="/lkdtWX/js/plugins/laydate/laydate.js"></script>
<!-- echarts -->
<script src="/lkdtWX/js/plugins/echarts/echarts.min.js"></script>
<script type="text/javascript" src="/lkdtWX/js/common-options.js"></script>
<!-- 高德地图 -->
<script language="javascript" src="https://webapi.amap.com/maps?v=1.4.14&key=0fb99186996b7bff85d606c80d16f224&plugin=Map3D,AMap.DistrictSearch"></script>
<!-- UI组件库 1.0 -->
<script type="text/javascript" src="https://webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
<!-- 地图数据展示 -->
<script	src="/fog/alarm/alarmMap.js?v=1.1.1&date=20201201"></script>

<script type="text/javascript">
    let map = null;
    //告警信息/告警闪烁点
    let alarmInfo = [];
    //轨迹描线
    let trackLines = [];
    //是否打开雾霾告警
    let fogOpen = true;
    //闪烁
    let triggerShackIndex = undefined;

    $(window).resize(function(){
        $("#alarmRoadList").height($("body").height() - $("#c_div_1").height() - $("#c_div_2").height() - $("#c_div_3").height() - 48 );
        $("#allmap").height($("body").height() - 20) ;
    });

    $(function () {
        //css
        $("#alarmRoadList").height($("body").height() - $("#c_div_1").height() - $("#c_div_2").height() - $("#c_div_3").height() - 48 );

        radioFunc();
    });

    function radioFunc(){
        initParam();
        updateNianduAndOtherAndQuery();
    }

    $('.form_date_year_month').datetimepicker({
        format: 'yyyy-mm',
        weekStart: 1,
        todayBtn:  1,
        autoclose: true,
        todayHighlight: 1,
        startView: 3,
        minView: 3,
        forceParse: false,
        language: 'zh-CN'
    }).on('changeDate', function() {
        //alert($('.form_date_year_month').datetimepicker("getDate").Format("yyyy-MM"))
        //$('#dtp_input_dtp_year_month').val()
        updateNianduAndOtherAndQuery();
    });

    $('.form_date_year').datetimepicker({
        format: 'yyyy',
        weekStart: 1,
        todayBtn:  1,
        autoclose: true,
        todayHighlight: 1,
        startView: 4,
        minView: 4,
        forceParse: false,
        language: 'zh-CN'
    }).on('changeDate', function() {
        updateNianduAndOtherAndQuery();

    });

    let openHighway = function(){
        layer.open({
            type:2,
            title:"选择公路",
            area : [ '300px', '450px' ],
            content:"/system/highway/treeView"
        })
    };

    function loadHy(node){
        let	hwId = node.id;
        let hwName = node.text;
        $("#hwId").val(hwId);
        $("#hwName").val(hwName);

        updateNianduAndOtherAndQuery();
    }

    function clearHwIdAndName(){
        $("#hwId").val("");
        $("#hwName").val("");

        updateNianduAndOtherAndQuery();
    }

    function initParam(){
        if($("#inlineRadio1")[0].checked){
            $('#selectYear').show();
            $('#selectYearMonth').hide();
            $('.form_date_year').datetimepicker("setDate", new Date());
        } else {
            $('#selectYear').hide();
            $('#selectYearMonth').show();
            $('.form_date_year_month').datetimepicker("setDate", new Date());
        }
    }

    function updateNianduAndOtherAndQuery(){

        if(triggerShackIndex){
            clearInterval(triggerShackIndex);
        }

        if($("#inlineRadio1")[0].checked){
            let year = $('.form_date_year_month').datetimepicker("getDate").Format("yyyy");
            $("#niandu").text(year + "年度");
            initRoadAlarm($('.form_date_year').datetimepicker("getDate").Format("yyyy"), $('#hwId').val());
            showInfo($('.form_date_year').datetimepicker("getDate").Format("yyyy"), $('#hwId').val());
        } else {
            let yearMonth = $('.form_date_year_month').datetimepicker("getDate").Format("yyyy-MM");
            yearMonth = yearMonth.split("-");
            $("#niandu").text(yearMonth[0] + "年度" + yearMonth[1] + "月份");
            //初始化告警路段列表
            initRoadAlarm($('.form_date_year_month').datetimepicker("getDate").Format("yyyy-MM"), $('#hwId').val());
            //地图渲染告警图标
            showInfo($('.form_date_year_month').datetimepicker("getDate").Format("yyyy-MM"), $('#hwId').val());
        }

    }

    let setTimerFunc_ = function(func1, func2, timer, bool){
        let time = setTimeout(opa, timer);
        let num = 0;
        function opa() {
            num = num === 0? 1: 0;
            clearTimeout(time);
            if(num === 0){
                func1();
            } else {
                func2();
            }
            if(!bool){
                return;
            }
            setTimeout(opa, timer);
        }
        return time;
    };

    function triggerShack(level){
        let loadIndex = layer.load(1);
        clearInterval(triggerShackIndex);
        triggerShackIndex = undefined;
        $("[src='/img/point_darkred.png']").css("opacity", 0.9);
        $("[src='/img/point_red.png']").css("opacity", 0.9);
        $("[src='/img/point_yellow.png']").css("opacity", 0.9);

        let point = undefined;
        let num = 0;
        function crossShack(){
            num ++;
            if(num === 1){
                point.css("opacity", 0.9);
            } else if(num === 2){
                point.css("opacity", 0.5);
            } else if(num === 3){
                point.css("opacity", 0.1);
                num = 0;
            }
        }

        switch(level){
            case 3:
                point = $("[src='/img/point_darkred.png']");
                triggerShackIndex = setInterval(function(){
                    crossShack();
                }, 200);
                break;
            case 2:
                point = $("[src='/img/point_red.png']");
                triggerShackIndex = setInterval(function(){
                    crossShack();
                }, 200);
                break;
            case 1:
                point = $("[src='/img/point_yellow.png']");
                triggerShackIndex = setInterval(function(){
                    crossShack();
                }, 200);
                break;
            default:break;
        }

        layer.close(loadIndex);
    }



    //地图初始化
    mapInitForFogStatistics();

    function mapInitForFogStatistics(){
    	$("#allmap").height($("body").height() - 20) ;
        let liveAddressJSON = {zoom:8, center:[119.793368,33.462547]};
        let map$zoom = liveAddressJSON.zoom;
        let map$center = liveAddressJSON.center;//初始地图中心点 江苏[119.117709,33.136569]  连云港[119.178133,34.596076 ]
        //创建地图
        map = new AMap.Map("allmap", {
            cursor: 'default',
            resizeEnable: true,
            zoom: map$zoom,
            center: map$center,
            mapStyle: "amap://styles/1de1ab4a6f3d6b4a31d558771f073fa2"
        });
        AMapUI.loadUI(['geo/DistrictExplorer'], function(DistrictExplorer) {
            initPage(DistrictExplorer,map);
        });

        map.on('zoomchange', function(e) {
            let zoom = map.getZoom(); //获取当前地图级别
            let lightRed = $(".wumai_light_red");	//雾：特级
            let red = $(".wumai_red");				//雾：一级
            let orange = $(".wumai_orange");		//雾：二级
            let yellow = $(".wumai_yellow");		//雾：三级
            let nofog = $(".nofog");				//雾：散
            let windRed = $(".wind-red");			//大风：一级、特级
            let windYellow = $(".wind-yellow");		//大风：二级、三级
            if(zoom > 10) {
                if(lightRed.length > 0){
                    lightRed.css({ height: (3*zoom)+'px', width: (3*zoom)+'px' });
                }
                if(orange.length > 0){
                    orange.css({ height: (3*zoom)+'px', width: (3*zoom)+'px' });
                }
                if(red.length > 0){
                    red.css({ height: (3*zoom)+'px', width: (3*zoom)+'px' });
                }
                if(yellow.length > 0){
                    yellow.css({ height: (3*zoom)+'px', width: (3*zoom)+'px' });
                }
                if(nofog.length > 0){
                    nofog.css({ height: (3*zoom)+'px', width: (3*zoom)+'px' });
                }
                if(windRed.length > 0){
                    windRed.css({ height: (3*zoom)+'px', width: (3*zoom)+'px' });
                }
                if(windYellow.length > 0){
                    windYellow.css({ height: (3*zoom)+'px', width: (3*zoom)+'px' });
                }
            } else {
                if(lightRed.length > 0){
                    lightRed.css({ height: '20px', width: '20px' });
                }
                if(orange.length > 0){
                    orange.css({ height: '20px', width: '20px' });
                }
                if(red.length > 0){
                    red.css({ height: '20px', width: '20px' });
                }
                if(yellow.length > 0){
                    yellow.css({ height: '20px', width: '20px' });
                }
                if(nofog.length > 0){
                    nofog.css({ height: '20px', width: '20px' });
                }
                if(windRed.length > 0){
                    windRed.css({ height: '20px', width: '20px' });
                }
                if(windYellow.length > 0){
                    windYellow.css({ height: '20px', width: '20px' });
                }
            }
        });
    }

    /**
     * 告警信息渲染
     * */
    function showInfo(yearMonth, hwId) {
        $.ajax({
            type: "GET",
            url: "/system/alarm/getAlarmCountGroupEpIdP",
            data: {date: yearMonth, hwId: 2, type: "fog"},
            dataType: 'json',
            success: function (data2) {
                $.ajax({
                    type: "GET",
                    url: "/system/alarm/getAlarmCountGroupEpIdP",
                    data: {date: yearMonth, hwId: hwId, type: "fog"},
                    dataType:'json',
                    success: function (data) {
                        if(data.code != 0){
                            layer.msg(data.msg);
                            return;
                        }
                        data = data.counts;
                        for(let index in data2.counts){
                            data.push(data2.counts[index]);
                        }
                        //告警闪烁点清空
                        alarmImgCloseAll(map);
                        let alarmHtml_right = "";
                        for (let i = 0; i < data.length; i++) {
                            //渲染告警闪烁
                            let tempContent = "/lkdtWX/img/point_yellow.png";
                            let zIndex = 100;

                            //闪烁点渲染
                            if(fogOpen && data[i].count < 1){

                            } else if(fogOpen && data[i].count < 2){
                                if(data[i].lon && data[i].lat){
                                    addCustomMarker(map,tempContent,new AMap.LngLat(parseFloat(data[i].lon), parseFloat(data[i].lat)),data[i].epId,data[i].equName,zIndex,data[i].address,data[i].count);
                                }
                            } else if(fogOpen && data[i].count < 3) {
                                tempContent = "/lkdtWX/img/point_red.png";
                                zIndex = 101;
                                if(data[i].lon && data[i].lat){
                                    addCustomMarker(map,tempContent,new AMap.LngLat(parseFloat(data[i].lon), parseFloat(data[i].lat)),data[i].epId,data[i].equName,zIndex,data[i].address,data[i].count);
                                }
                            } else if(fogOpen && data[i].count >= 3) {
                                tempContent = "/lkdtWX/img/point_darkred.png";
                                zIndex = 102;
                                if(data[i].lon && data[i].lat){
                                    addCustomMarker(map,tempContent,new AMap.LngLat(parseFloat(data[i].lon), parseFloat(data[i].lat)),data[i].epId,data[i].equName,zIndex,data[i].address,data[i].count);
                                }
                            }

                            try{
                                //***告警信息---右边start***
                                try{
                                    if(data[i].distance != -1){
                                        alarmHtml_right += '<div class="panel panel-default">';
                                        if(data[i].distance == -1){
                                            alarmHtml_right += '<div class="panel-heading" style="background-color: lightcoral;">异常设备</div>';
                                        } else {
                                            if(data[i].distance >= 200){
                                                alarmHtml_right += '<div class="panel-heading" style="background-color: yellow !important;">黄色告警(100~200m)</div>';
                                            } else if(data[i].distance >= 100){
                                                alarmHtml_right += '<div class="panel-heading" style="background-color: yellow !important;">黄色告警(100~200m)</div>';
                                            } else if(data[i].distance >= 50){
                                                alarmHtml_right += '<div class="panel-heading" style="background-color: orange !important;">橙色告警(50~100m)</div>';
                                            } else if(data[i].distance >= 0){
                                                alarmHtml_right += '<div class="panel-heading" style="background-color: red !important;">红色告警(0~50m)</div>';
                                            }
                                        }
                                        date=new Date(data[i].begintime);

                                        var year = date.getFullYear();
                                        var month = date.getMonth()+1;
                                        var day = date.getDate();
                                        var dateStr=year+'-'+month+'-'+day;
                                        let $src_src_ = data[i].imgfn;
                                        alarmHtml_right +=
                                            '<div class="panel-body">'+
                                            '<div class="expand-popc-width">'+
                                            '<div class="expand-popc-left">'+
                                            '<img src="'+$src_src_+'" alt="告警图片" onclick="expand_popc_click(this);" class="img-rounded">'+
                                            '</div>'+
                                            '<div class="expand-popc-right">'+
                                            '可见距离：<span>'+data[i].distance+'米</span>'+
                                            '<br/>桩号：<span>'+data[i].equName+'</span>'+
                                            '<br/>路段：<span>'+data[i].address+'</span>'+
                                            '</div>'+
                                            '</div>'+
                                            '<label>2020-05-16 01:28:56</label>'+
                                            '</div>'+
                                            '</div>';

                                    }
                                } catch (e) {
                                    console.log(e);
                                }
                                //***告警信息---右边end***
                            } catch (e) {
                                console.log(e);
                            }
                        }
                        $("#expand-popc").html(alarmHtml_right);
                        //路线三色图
                        if(data.length > 0){
                            $.ajax({url: '/fog/fogTrack/getAlarmTrackFogStatistics',
                                type: 'post',
                                data: {epJson: JSON.stringify(data)},
                                dataType: 'json',
                                success: function (data) {
                                    //清除路径
                                    for(;trackLines.length > 0;){
                                        trackLines.shift().setMap(null);
                                    }
                                    //////////////////////////
                                    if(data && data.length > 0){
                                        data.forEach(function(curr,index,arr){
                                            if(curr.color && curr.track){
                                                polylineFunc(curr.track,curr.color);
                                            }
                                        });
                                    }
                                }
                            });
                        }

                    }
                });
            }
        });

    }

    /**定义闪烁点divMarker*/
    function addCustomMarker(map,content,position,epId,name,zIndex,equLocation,count){
        let marker1 = new AMap.Marker({
            offset:new AMap.Pixel(-10,-10), //相对于基点的偏移位置
            draggable:false,  //是否可拖动
            content:`<img src="`+content+`" style="width:20px;height:20px;opacity:0.9;cursor: pointer;" title="` + name +` 雾霾` + count + `次">` +
                    `<span id="span_` + epId + `" style="white-space: nowrap; font-size: 1px; color: blue; display: none;">` + name +` 雾霾` + count + `次<span>` +
                    `<img>`,   //自定义覆盖物内容,
            position:position, //基点位置
            zIndex:zIndex//显示级别
        });
        marker1.on( 'click', function(){
            layer.msg(`【` + name +`】 雾霾` + count + `次`)
            //realImgViewFunc(epId,name,equLocation);
        });
        marker1.on( 'mouseover', function(){
            $("#span_" + epId).show();
        });
        marker1.on( 'mouseout', function(){
            $("#span_" + epId).hide();
        });
        map.add(marker1);
        alarmInfo.push(marker1);
    }

    function realImgViewFunc(epId,name,equLocation){
        hasClose=0;
        $.ajax({url: '/system/equipment/lookup/updateimgpath/'+epId,
            type: 'post',
            dataType: 'json',
            success: function (data) {
                //清除路径
                if(data.fMeter){
                    layer.open({
                        type : 2,
                        title : "ID："+epId+" >> 桩号："+name+" >> 位置："+equLocation,
                        maxmin : false,
                        shadeClose : false, // 点击遮罩关闭层
                        area : [ '60%', '90%' ],
                        zIndex:99999999,
                        content : '/system/equipment/home_lookup/' + epId
                    });
                }
                else{
                    layer.msg("前端监控平台维护中", {time: 1000});
                }
            }
        });
    }

    /**
     * 根据坐标列表划线
     * */
    function polylineFunc(equipmentLngLat,colorDesc){
        //给定路径划线
        let polyline = new AMap.Polyline({
            path: JSON.parse(equipmentLngLat),            // 设置线覆盖物路径
            strokeColor: colorDesc,   // 线颜色
            strokeOpacity: 1,         // 线透明度
            strokeWeight: 5,          // 线宽
            strokeStyle: 'dashed',     // 线样式
            strokeDasharray: [0,0,0], // 补充线样式
            geodesic: true,            // 绘制大地线
            bubble:true,
            isOutline:true,
            outlineColor:'white',
        });
        polyline.setMap(map);
        trackLines.push(polyline);
    }

    /**
     * 清空所有告警闪烁点
     */
    function alarmImgCloseAll(){
        while(alarmInfo.length > 0){
            map.remove(alarmInfo.shift());
        }
        //清除路径
        for(;trackLines.length > 0;){
            trackLines.shift().setMap(null);
        }
    }

    /*********告警路段列表 start ****************/
    function initRoadAlarm(yearMonth, hwId){
        $.ajax({
            type : 'get',
            url : '/fog/alarmRoad/queryEventAlarmRoadStatistics',
            data:{hwId: 2, date: yearMonth, type: 'fog'},
            success : function(dataAll2) {
                $.ajax({
                    type : 'get',
                    url : '/fog/alarmRoad/queryEventAlarmRoadStatistics',
                    data:{hwId: hwId, date: yearMonth, type: 'fog'},
                    success : function(dataAll) {
                        let data = dataAll;
                        for(let index in dataAll2){
                            data.push(dataAll2[index]);
                        }
                        let html = "";
                        for (let i = 0; i < data.length; i++) {
                            html += "<ul>";
                            html += "<li class='li_color' ><a href='###' style='color: #95C1EE;' " +
                                "title='" +data[i].hwName + "' onclick='showRoadClose(\""+data[i].hwId+"\")'>" +
                                data[i].hwName+ "</a></li>";
                            html += "<li class='li_color' ><a href='###' style='color: #95C1EE;' onclick='"+"locationFunc("+data[i].hwId+")"+"'>" +
                                data[i].statisticsDate + "</a></li>";
                            html += "<li>" + data[i].statisticsNum + "</li>";
                            html += "<li>" + data[i].mileage + "</li>";
                            html += "<li>" + data[i].minDistance + "（米）</li>";
                            html += "<li>" + data[i].avgTime + "</li>";
                            html += "</ul>";
                        }
                        $("#contentUl").html(html);

                    }
                });

            }
        });

    }



    /**将分钟数量转换为小时和分钟**/
    function toHourMinute(minutes){
        if(minutes === "" || minutes == null){
            return "未结束";
        }
        if(!isNaN(minutes)){
            return (Math.floor(minutes/60) + "小时" + (minutes%60) + "分" );
        }else{
            return "未结束";
        }
    }

    /**
     * 警告列表路段定位
     * */
    function locationFunc(hwId){

    }

    function openFog(epId,epName,hwName,beginTime,endTime){
        layer.open({
            type : 2,
            title : "ID："+epId+" >> 桩号："+epName+" >> 位置："+hwName,
            maxmin : true,
            shadeClose : false, // 点击遮罩关闭层
            area : [ '75%', '100%' ],
            zIndex:99999999,
// 	        content : '/report/alarmReport/alarmEquipment?epId='+epId+'&epName='+epName+'&hwName='+hwName+'&beginTime='+beginTime+'&endTime='+endTime
            content : '/report/alarmReport/alarmEquipment?epId='+epId+'&beginTime='+beginTime+'&endTime='+endTime
        });
    }

    function showRoadClose(hwId){


    }

    function showLevenDesc(alarmLevel){
        if(alarmLevel == 1){
            return "三级告警";
        }else if(alarmLevel == 2){
            return "二级告警";
        }else if(alarmLevel == 3){
            return "一级告警";
        }else if(alarmLevel == 4){
            return "特级告警";
        }else if(alarmLevel == 0){
            return "告警解除";
        }else{
            return "未知级别";
        }
    }
    /*********告警摄像头列表 end ****************/

</script>

</body>
</html>