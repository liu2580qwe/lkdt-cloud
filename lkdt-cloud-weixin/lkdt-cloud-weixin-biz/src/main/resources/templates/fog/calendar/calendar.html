<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
  <!-- Bootstrap -->
  <link href="css/bootstrap.min.css?v=3.3.6" th:href="@{/css/bootstrap.min.css?v=3.3.6}" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="/css/font-awesome.min.css" rel="stylesheet">
  <!-- NProgress -->
  <link href="/css/nprogress.css" rel="stylesheet">
  <!-- FullCalendar -->
  <link href="/css/plugins/fullcalendar/fullcalendar.min.css" rel="stylesheet">
  <link href="/css/plugins/fullcalendar/fullcalendar.print.css" rel="stylesheet" media="print">
  <style>
    .fc-close:hover{
      background-color: #2A84F6;
    }
    .modal-dialog {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }
    .modal-content {
      overflow-y: scroll;
      position: fixed;
      top: 0;
      bottom: 0;
    }
    .modal-content::-webkit-scrollbar {/*滚动条整体样式*/
      width: 10px;     /*高宽分别对应横竖滚动条的尺寸*/
      height: 1px;
    }
    .modal-content::-webkit-scrollbar-thumb {/*滚动条里面小方块*/
      border-radius: 10px;
      -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
      background: #FF9995;
    }
    .modal-content::-webkit-scrollbar-track {/*滚动条里面轨道*/
      -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
      border-radius: 10px;
      background: #EDEDED;
    }
  </style>
</head>
<body class="nav-md" style="background-color: rgba(0,0,0,0);color: white;">
<div class="container body">
  <div class="main_container">
    <!-- page content -->
    <div class="right_col" role="main">
      <div class="">
        <div class="page-title">

          <div class="title_right">
            <div class="col-md-5 col-sm-5 col-xs-12 form-group pull-right top_search">
              <div class="input-group" style="margin-top: 10px;">
                <input id="hwId" name="hwId" class="hidden">
                <input id="name" name="name" class="form-control" type="text" style="cursor: pointer;background-color: #cdd6dc;" onclick="openHighway()"
                       readonly="readonly" placeholder="所属公路">
                <span class="input-group-btn">
                      <button class="btn btn-default" type="button" onclick="showInfo()">搜索</button>
                    </span>
              </div>
            </div>
          </div>
        </div>

        <div class="clearfix"></div>

        <div class="row">
          <div class="col-md-12">
            <div class="x_panel">
              <div class="x_content">
                <div id='calendar'></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- /page content -->
  </div>
</div>

<!-- calendar modal -->
<div id="CalenderModalEdit" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title" id="myModalLabel2">告警详情<span  id="equName" name="equName" readonly="readonly"></span></h4>
      </div>
      <div class="modal-body">

        <div id="testmodal2" style="padding: 5px 20px;">
          <form id="antoform2" class="form-horizontal calender" role="form">
            <div class="form-group">
              <label class="col-sm-2 control-label">能见度</label>
              <div class="col-sm-4">
                <input type="text" class="form-control" id="distance" name="distance" readonly="readonly">
              </div>
              <label class="col-sm-2 control-label">开始时间</label>
              <div class="col-sm-4">
                <!-- <textarea class="form-control" style="height:55px;" id="begintime" name="begintime"></textarea> -->
                <input type="text" class="form-control" id="begintime" name="begintime" readonly="readonly">
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-2 control-label">结束时间</label>
              <div class="col-sm-4">
                <input type="text" class="form-control" id="endtime" name="endtime" readonly="readonly">
              </div>
              <label class="col-sm-2 control-label">雾霾等级</label>
              <div class="col-sm-4">
                <input type="text" class="form-control" id="level" name="level" readonly="readonly">
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-2 control-label">时长</label>
              <div class="col-sm-4">
                <input type="text" class="form-control" id="timeDifference" name="timeDifference" readonly="readonly">
              </div>
              <label class="col-sm-2 control-label">是否有效</label>
              <div class="col-sm-4">
                <input type="text" class="form-control" id="iseffective" name="iseffective" readonly="readonly">
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-2 control-label">图片</label>
              <div class="col-sm-9">
                <img id="img1" src="/lkdtWX/img/p_big2.jpg" style="width:100%;height:auto;">
              </div>
            </div>

          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default antoclose2" data-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<!-- calendar modal -->
<div id="CalenderTollStation" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="height: 500px">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
        <h4 class="modal-title">封路详情<span  id="equName" name="equName" readonly="readonly"></span></h4>
      </div>
      <div class="modal-body">
        <div id="testmodal2" style="padding: 0px 5px;">
          <div id="param">
            <input id="startTime" type="hidden">
            <label class="form-inline">路段：<input id="roadNum_" style="color:black;" class="form-control" type="text" autocomplete="off"/></label>
            <label class="form-inline">收费站：<input id="tsName_" style="color:black;" class="form-control" type="text" autocomplete="off"/></label>
          </div>
          <table class="table table-bordered table-striped table-hover"
                 id="stolllist" style="margin-top: 0px;width: 100%;height: 300px;">
            <thead>
              <tr>
                <td width="20" align="center">序号</td>
                <td width="20" align="center">路段</td>
                <td width="20" align="center">收费站</td>
                <td width="20" align="center">出/入口</td>
                <td width="20" align="center">方向</td>
                <td width="20" align="center">封路时间</td>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default antoclose2" data-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<div id="fc_edit" data-toggle="modal" data-target="#CalenderModalEdit"></div>

<div id="fc_stoll_station" data-toggle="modal" data-target="#CalenderTollStation"></div>

<div id="mydiv1" class="fc-popover fc-more-popover" style="display: none;background-color: #313046;cursor: pointer;">
  <div class="fc-header fc-widget-header">
    <span class="fc-close fc-icon fc-icon-x"></span>
    <span class="fc-title">XXXX-XX-XX</span>
    <div class="fc-clear"></div>
  </div>
  <div class="fc-body fc-widget-content">
    <div class="fc-event-container">
      <a class="fc-day-grid-event fc-h-event fc-event fc-start fc-end" style="background-color:#F8AC59;border-color:#F8AC59">
        <div class="fc-content">
          <span class="fc-time fa fa-question-circle-o">&nbsp;1a</span>
          <span class="fc-title">XXXX</span>
        </div>
      </a>
      <a class="fc-day-grid-event fc-h-event fc-event fc-start fc-end" style="background-color:#F8AC59;border-color:#F8AC59">
        <div class="fc-content">
          <span class="fc-time fa fa-question-circle-o">&nbsp;1:37a</span>
          <span class="fc-title">XXXX</span>
        </div>
      </a>
    </div>
  </div>
</div>
<!-- /calendar modal -->

<!-- jQuery -->
<script src="/lkdtWX/js/jquery.min.js?v=2.1.4"></script>
<!-- Bootstrap -->
<script src="/lkdtWX/js/bootstrap.min.js?v=3.3.6"></script>
<!-- FastClick -->
<script src="/lkdtWX/js/fastclick.js"></script>
<!-- NProgress -->
<script src="/lkdtWX/js/nprogress.js"></script>
<!-- FullCalendar -->
<script src="/lkdtWX/js/plugins/fullcalendar/moment.min.js"></script>
<script src="/lkdtWX/js/plugins/fullcalendar/fullcalendar.min.js"></script>

<script src="/lkdtWX/js/plugins/layer/layer.js"></script>

<!-- FullCalendar -->
<script>
    $(window).load(function() {
        $('#calendar').fullCalendar(option_);
    });

    var date = new Date();
    var month = date.getMonth() + 1<10? "0"+(date.getMonth() + 1):date.getMonth() + 1;
    var strDate = date.getDate()<10? "0" + date.getDate():date.getDate();
    var currentdate = date.getFullYear() + "-"  + month  + "-"  + strDate;

    var option_ = {
      height: '300px',
      aspectRatio:2,
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        monthNames: ["一月", "二月", "三月", "四月", 　//设置月份名称，中英文均可
            "五月", "六月", "七月", "八月", "九月",
            "十月", "十一月", "十二月"
        ],
        monthNamesShort: ["一月", "二月", "三月",　　//设置月份的简称
            "四月", "五月", "六月", "七月", "八月",
            "九月", "十月", "十一月", "十二月"
        ],
        dayNames: ["周日", "周一", "周二", "周三",　　//设置星期名称
            "周四", "周五", "周六"
        ],
        dayNamesShort: ["周日", "周一", "周二",　　　　//设置星期简称
            "周三", "周四", "周五", "周六"
        ],
        today: ["今天"],
        buttonText: { 　　　　　　　　　　　　　　　　　//设置按钮文本
            today: '今天',
            month: '月',
            week: '周',
            day: '日',
        },
        eventLimit: true,
        selectable: false,
        selectHelper: false,
        eventClick: function(calEvent,jsEvent, view) {
            if(calEvent.data){
              show(jsEvent,'mydiv1',calEvent.data);
            } else {
              showClickStollStation(jsEvent,calEvent.start);
            }
            event.stopPropagation();

        },
        editable: false,
        events:function(start,end,timezone, callback) {
            var hwId = $("#hwId").val();
            $.ajax({
                type : "GET",
                data:{hwId:hwId},
                url : "/system/alarm/selectByUserDeptId",
                success: function(data) { // 获取当前月的数据
                    var gZhiEvent = [];
                    var gZhiEvent1 = [];
                    var gZhiEvent2 = [];
                    var gZhiEvent3 = [];
                    gZhiEvent1.indexOfStart = function(start){
                        for(var i = 0; i < this.length; i++){
                            if(this[i].start == start){
                                return i;
                            }
                        }
                        return -1;
                    };
                    gZhiEvent2.indexOfStart = function(start){
                        for(var i = 0; i < this.length; i++){
                            if(this[i].start == start){
                                return i;
                            }
                        }
                        return -1;
                    };
                    gZhiEvent3.indexOfStart = function(start){
                        for(var i = 0; i < this.length; i++){
                            if(this[i].start == start){
                                return i;
                            }
                        }
                        return -1;
                    };
                    for(var i=0;i<data.length;i++){
                        var level="";
                        var d1 = new Date(data[i].begintime);
                        var d2;
                        if(data[i].endtime==null){
                            d2 = new Date();
                        }else{
                            d2 = new Date(data[i].endtime);
                        }
                        var d = parseInt(d2 - d1) / 1000 / 60/60;
                        var color="";
                        if(data[i].level==1){
                            level="大雾";
                            color="#3A87AD";
                        }else if(data[i].level==2){
                            level="浓雾";
                            color="#F8AC59";
                        }else if(data[i].level==3){
                            level="特浓雾";
                            color="#ED5565";
                        }
                        var iseffective = "" ;
                        var addr = data[i].equName;
                        if(data[i].iseffective==9){
                            iseffective="未确认";
                        }else if(data[i].iseffective==1){
                            iseffective="确认有效";
                        }
                        var imgpath=data[i].imgpath;
                        var epid=data[i].epId;

                        var eventTemp = {start:'',end:'',title:'',data:[]};

                        var gZhiEventIndex = -1;
                        if(data[i].distance <= 50){
                            if((gZhiEventIndex = gZhiEvent1.indexOfStart(data[i].begintime.substr(0,10))) != -1){
                                gZhiEvent1[gZhiEventIndex].data.push({title:addr, start:data[i].begintime, end:data[i].endtime, level:level,data:d.toFixed(2),color:color,iseffective:iseffective,imgpath:imgpath,imgTime:data[i].imgtime,epid:epid,distance:data[i].distance});
                                gZhiEvent1[gZhiEventIndex].title = '1级.(0~50m)：'+gZhiEvent1[gZhiEventIndex].data.length+'个';
                            } else {
                                eventTemp.start = data[i].begintime.substr(0,10);
                                eventTemp.end = data[i].begintime.substr(0,10);
                                eventTemp.data.push({title:addr, start:data[i].begintime, end:data[i].endtime, level:level,data:d.toFixed(2),color:color,iseffective:iseffective,imgpath:imgpath,imgTime:data[i].imgtime,epid:epid,distance:data[i].distance});
                                eventTemp.color = '#ff0000';
                                eventTemp.title = '1级.(0~50m)：'+eventTemp.data.length+'个';
                                gZhiEvent1.push(eventTemp);
                            }
                        } else if(data[i].distance <= 100){
                            if((gZhiEventIndex = gZhiEvent2.indexOfStart(data[i].begintime.substr(0,10))) != -1){
                                gZhiEvent2[gZhiEventIndex].data.push({title:addr, start:data[i].begintime, end:data[i].endtime, level:level,data:d.toFixed(2),color:color,iseffective:iseffective,imgpath:imgpath,imgTime:data[i].imgtime,epid:epid,distance:data[i].distance});
                                gZhiEvent2[gZhiEventIndex].title = '2级.(50~100m)：'+gZhiEvent2[gZhiEventIndex].data.length+'个';
                            } else {
                                eventTemp.start = data[i].begintime.substr(0,10);
                                eventTemp.end = data[i].begintime.substr(0,10);
                                eventTemp.data.push({title:addr, start:data[i].begintime, end:data[i].endtime, level:level,data:d.toFixed(2),color:color,iseffective:iseffective,imgpath:imgpath,imgTime:data[i].imgtime,epid:epid,distance:data[i].distance});
                                eventTemp.color = '#ff9300';
                                eventTemp.title = '2级.(50~100m)：'+eventTemp.data.length+'个';
                                gZhiEvent2.push(eventTemp);
                            }
                        } else if(data[i].distance <= 200){
                            if((gZhiEventIndex = gZhiEvent3.indexOfStart(data[i].begintime.substr(0,10))) != -1){
                                gZhiEvent3[gZhiEventIndex].data.push({title:addr, start:data[i].begintime, end:data[i].endtime, level:level,data:d.toFixed(2),color:color,iseffective:iseffective,imgpath:imgpath,imgTime:data[i].imgtime,epid:epid,distance:data[i].distance});
                                gZhiEvent3[gZhiEventIndex].title = '3级.(100~200m)：'+gZhiEvent3[gZhiEventIndex].data.length+'个';
                            } else {
                                eventTemp.start = data[i].begintime.substr(0,10);
                                eventTemp.end = data[i].begintime.substr(0,10);
                                eventTemp.data.push({title:addr, start:data[i].begintime, end:data[i].endtime, level:level,data:d.toFixed(2),color:color,iseffective:iseffective,imgpath:imgpath,imgTime:data[i].imgtime,epid:epid,distance:data[i].distance});
                                eventTemp.color = '#FFD700';
                                eventTemp.title = '3级.(100~200m)：'+eventTemp.data.length+'个';
                                gZhiEvent3.push(eventTemp);
                            }
                        }
                    }
                    if(gZhiEvent1.length > 0){
                        gZhiEvent = gZhiEvent.concat(gZhiEvent1);
                    }
                    if(gZhiEvent2.length > 0){
                        gZhiEvent = gZhiEvent.concat(gZhiEvent2);
                    }
                    if(gZhiEvent3.length > 0){
                        gZhiEvent = gZhiEvent.concat(gZhiEvent3);
                    }
                    callback(gZhiEvent);

                    /*$.ajax({
                        type: "GET",
                        data: {hwId: hwId},
                        url: "/system/tollStationRecorder/getTollStationInfo",
                        success: function (data) {
                            let gZhiEvent4 = [];
                            gZhiEvent4.indexOfStart = function(start){
                                for(var i = 0; i < this.length; i++){
                                    if(this[i].start == start){
                                        return i;
                                    }
                                }
                                return -1;
                            };
                            if(data != null && data != ""){
                                data = JSON.parse(data);
                                let gZhiEventIndex = -1;
                                for(let i = 0; i < data.length; i++){
                                    let eventTemp = {};
                                    if((gZhiEventIndex = gZhiEvent4.indexOfStart(data[i].date)) != -1){
                                        gZhiEvent4[gZhiEventIndex].title = '出/入口'+data[i].date+'关闭'+data[i].count+'个';
                                    } else {
                                        eventTemp.start = data[i].date;
                                        eventTemp.end = dateFormat("YYYY-mm-dd", new Date());
                                        eventTemp.color = '#ff9995';
                                        eventTemp.title = '出/入口'+data[i].date+'关闭'+data[i].count+'个';
                                        gZhiEvent4.push(eventTemp);
                                    }
                                }
                                gZhiEvent = gZhiEvent.concat(gZhiEvent4);
                            }
                            callback(gZhiEvent);
                        }
                    });*/
                }
            });
        },
    };

    $('.fc-close').bind('click',function(event){
        hide(event,'mydiv1');
        event.stopPropagation();
    });
    $('#mydiv1').bind('click',function(event){
        event.stopPropagation();
    });
    $(document).bind('click',function(event){
        //hide(event,'mydiv1');
    });

    //弹出框参数
    var showClickData = [];
    function show(obj,id,data) {
        showClickData = data;
        var objDiv = $("#"+id+"");
        $(objDiv).css("display","block");
        $(objDiv).css("left", obj.pageX - obj.offsetX);
        $(objDiv).css("top", obj.pageY-obj.offsetY);
        $('#'+id+' .fc-title').text(obj.currentTarget.childNodes[0].innerText);
        $('#'+id+' .fc-event-container').empty();
        data.forEach(function(curr,index,att){
            $('#'+id+' .fc-event-container').append('<a class="fc-day-grid-event fc-h-event fc-event fc-start fc-end" ' +
                'style="'+obj.currentTarget.attributes['style'].nodeValue+'"onclick="showClick('+index+')"><div class="fc-content">' +
                '<span class="fc-time fa fa-question-circle-o">&nbsp;'+curr.start.substr(11,8)+'</span><span class="fc-title">'+curr.title+'</span></div></a>');
        });
    }

    $("#roadNum_").bind("input propertychange change", function(event) {
        search();
    });

    $("#tsName_").bind("input propertychange change", function(event) {
        search();
    });

    /**
     * 弹出框点击事件
     * @param index
     */
    function showClickStollStation(event,startTime){
        $('#fc_stoll_station').click();
        $('#startTime').val(startTime._i);
        search();
    }

    function search(){
      $.ajax({
        type: "GET",
        data: {roadNum:$("#roadNum_").val(),tsName:$("#tsName_").val(),closeTime: $('#startTime').val()},
        url: "/system/tollStationRecorder/getTollStationList",
        success: function (data) {
          if(data != undefined && data != null){
            $('#stolllist').find("tbody").empty();
            for(let i = 0; i < data.length; i++){
              $('#stolllist').append( '<tr>'+
                '<td>'+data[i].tsnum+'</td>'+
                '<td>'+data[i].roadnum+'</td>'+
                '<td>'+data[i].tsname+'</td>'+
                '<td>'+data[i].direction+'</td>'+
                '<td>'+(data[i].io=="1"?"入口":"出口")+'</td>'+
                '<td>'+data[i].closetime+'</td>'+
                '</tr>');
            }
          }
        }
      });
    }

    /**
     * 弹出框点击事件
     * @param index
     */
    function showClick(index){
        var calEvent = showClickData[index];
        $('#fc_edit').click();
        $('#distance').val(calEvent.distance+"米");
        $('#equName').html(calEvent.title);
        $('#begintime').val(calEvent.start);
        if(calEvent.end!=null){
            $('#endtime').val(calEvent.end);
        }
        $('#level').val(calEvent.level);
        $('#timeDifference').val(calEvent.data+'(h)');
        $('#iseffective').val(calEvent.iseffective);
        /* if(calEvent.imgTime.substring(0,10)==currentdate){
        }else{ */
            $('#img1').attr("src",calEvent.imgpath);
        //}
        $(".antosubmit2").on("click", function() {
            $('.antoclose2').click();
        });
    }

    function hide(obj,id) {
        var objDiv = $("#"+id+"");
        $(objDiv).css("display", "none");
    }

    function showInfo(){
        $('#calendar').fullCalendar('refetchEvents');
    }

    var openHighway = function  (){
        layer.open({
            type:2,
            title:"选择公路",
            area : [ '300px', '450px' ],
            content:"/system/highway/treeView"
        })
    }

    function loadHy( node ){
    	var	hwId = node.id;
    	var name = node.text;
        $("#hwId").val(hwId);
        $("#name").val(name);
    }

    function dateFormat(fmt, date) {
      let ret;
      const opt = {
        "Y+": date.getFullYear().toString(),        // 年
        "m+": (date.getMonth() + 1).toString(),     // 月
        "d+": date.getDate().toString(),            // 日
        "H+": date.getHours().toString(),           // 时
        "M+": date.getMinutes().toString(),         // 分
        "S+": date.getSeconds().toString()          // 秒
        // 有其他格式化字符需求可以继续添加，必须转化成字符串
      };
      for (let k in opt) {
        ret = new RegExp("(" + k + ")").exec(fmt);
        if (ret) {
          fmt = fmt.replace(ret[1], (ret[1].length == 1) ? (opt[k]) : (opt[k].padStart(ret[1].length, "0")))
        };
      };
      return fmt;
    }
</script>
<!-- /FullCalendar -->
</body>
</html>