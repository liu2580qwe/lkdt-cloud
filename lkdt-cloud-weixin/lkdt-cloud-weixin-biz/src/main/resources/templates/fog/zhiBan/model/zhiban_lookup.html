<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head th:include="include :: header"></head>
<link href="/css/plugins/fullcalendar/fullcalendar.min.css" rel="stylesheet">
<link href="/css/plugins/fullcalendar/fullcalendar.print.css" rel="stylesheet" media="print">
<link rel="stylesheet" type="text/css" href="/lkdtWX/js/plugins/layer/skin/layer.css?v=2">
<style>
	p{
		margin: 0 0 14px;
		font-size: 3.1vw;
		color: #f1a908;
	}
	.col-md-4{
		width: 33.33%;
		float: left;
	}
	.fc-icon-x:after {
		font-size: 290%;
	}
</style>
<script>
    function nofind(_this){
        _this.src="/fog/nofind.jpg";
    }
</script>
<body class="gray-bg" style="height: 97%; overflow: hidden; padding: 5px; background: #132535;">
	<input id="epId" name="epId" type="hidden" th:value="${epId}">
	<input id="path" name="path" type="hidden" th:value="${path}">
	<input id="fMeter" name="fMeter" type="hidden" th:value="${fMeter}">
	<input id="videopath" name="videopath" type="hidden" th:value="${videopath}">
	<div class="row" style="height: 50%;width: 100%;">
		<div id="mydiv1" class="fc-popover fc-more-popover" style="display: none;background-color: #313046;cursor: pointer;width: 50%;position: absolute;
    z-index: 9999;left: 0;">
			<img id="clickimg" alt="" src="" style="width: 90%;margin-left: 8%; max-height: 35vw;">
			<span class="fc-close fc-icon fc-icon-x"></span>
			alarmId: <span id="alarmId">123131232</span><br>
			<span style="margin-left: 23px;">start:</span><input id="startTime" placeholder="yyyy-MM-dd HH:mm:ss" style="width: 180px;" autocomplete="off"/><br/>
			<span style="margin-left: 23px;">end:</span><input id="endTime" placeholder="yyyy-MM-dd HH:mm:ss" style="width: 180px;" autocomplete="off"/><br/>
			<span style="margin-left: 23px;">distance:</span><input id="add_alarm_distance" type="number" placeholder="可见距离" style="width: 180px;" autocomplete="off"/>
			<button style="margin-left: 5px;" onclick="show_confirm()">提交告警</button>
		</div>
		<div class="col-md-6" style="background-color: #090a21; color: #fff; font-size: 15px;padding: 5px;height: 100%;
			padding-left: 40px;width: 50%;float: left; font-family: sans-serif;">
			<span style="display: none;">
				<p>当前可见距离：<span id="mi"></span>米<!-- （<span id="zhuangtai"></span>）  --></p>
	 			<p>当前雾趋势：无 </p>
				<p>今日最大可见距离：<span id="maxDay"></span>米 </p>
				<p>今日最低可见距离：<span id="minDay"></span>米 </p>
				<input id="close" type="button" onclick="closeFog()" style="display: none; position: fixed; top: 0px; left: 38%;" value="关闭告警"/>
			</span>
			<iframe id="rgjzIfram" style="width: 100%; height: 100%; "></iframe>
		</div>
		<div class="col-md-6" style="height: 100%;width: 50%;float: left;">
			<div style="text-align: center; height: 100%; float: left; width: 100%;">
				<img id='img1' alt="" onerror="nofind(this)" style="height: 100%;width: auto;margin:auto;display: none;">
				<div id="video123" style="height: 100%;width: 100%;"></div>
				<div id='fMeter_V'  style="position: absolute;top: 75%;left: 20%;color: #ff9d06;font-size: 22px;" th:value="${fMeter}"></div>
			</div>

		</div>
	</div>
	<div class="row" style="height: 50%;width: 99%;">
		<div class="col-md-12" style="height: 100%;">
			<div id="container1" style="height: 100%;width:100%;"></div>
			<div id="container2" style="height: 100%;width:100%;display: none;"></div>
		</div>
	</div>
	<!-- ECharts -->
	<script src="/lkdtWX/js/plugins/echarts/echarts.min.js"></script>
	<script src="/lkdtWX/js/common-options.js"></script>
	<script type="text/javascript" src="/lkdtWX/js/jquery.min.js" ></script>
	<script type="text/javascript" src="/lkdtWX/js/plugins/layer/layer.min.js?v=2&date=20201125"></script>
	<script src="/lkdtWX/js/ckplayer/ckplayer.min.js"></script>
	<!-- FastClick -->
	<script src="/lkdtWX/js/fastclick.js"></script>
</body>
<script type="text/javascript">
	/**
	 判断输入框中输入的日期格式是否为年月日时分秒 即 yyyy-mm-dd hh:mi:ss
	 */
	function isDate(dateString){
		if(dateString.trim() == "")return true;
		//年月日时分秒正则表达式
		let r = dateString.match(/^(\d{1,4})\-(\d{1,2})\-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})$/);
		if(r == null){
			return false;
		}
		let d = new Date(r[1],r[2]-1,r[3],r[4],r[5],r[6]);
		let num = (d.getFullYear()==r[1]&&(d.getMonth()+1)==r[2]&&d.getDate()==r[3]&&d.getHours()==r[4]&&d.getMinutes()==r[5]&&d.getSeconds()==r[6]);
		return (num!=0);

	}

	function show_confirm() {
		layer.confirm("请确认提交请求？",{}, function(){
			if($("#startTime").val() === "" || $("#endTime").val() === "" || $("#add_alarm_distance").val() === ""){
				layer.msg("参数为空");
				return;
			}
			if(!isDate($("#startTime").val()) || !isDate($("#endTime").val())){
				layer.msg("日期时间格式不正确");
				return;
			}
			$.ajax({
				type : "post",
				url : "/system/alarm/adjustAlarm",
				data: {"epId": $("#epId").val(), "alarmId": $("#alarmId")[0].innerText, "begintime": $("#startTime").val(),
					"endtime": $("#endTime").val(), "distance": $("#add_alarm_distance").val()},
				success : function(res) {
					updateImgPath();
					layer.msg(res.msg);
				}
			});
			layer.msg("提交成功!");
		}, function(){
			layer.msg("已取消");
		});
	}

	//过滤统计
    let dom1 = document.getElementById("container1");
    let myChart1 = echarts.init(dom1);
    let imgpathsjson = [];
    let alarmId_xAxis = [];
    let option = JSON.parse(JSON.stringify(common_options1_zhiban));
    myChart1.getZr().on('click', function (params) {
		let pointInPixel = [params.offsetX, params.offsetY];
	    if (myChart1.containPixel('grid',pointInPixel)) {
	        /*此处添加具体执行代码*/
            
            let pointInGrid = myChart1.convertFromPixel({seriesIndex:0},pointInPixel);
	        //X轴序号
	        let xIndex = pointInGrid[0];

            //获取当前图表的option
	        let op = myChart1.getOption();
 
            //获得图表中我们想要的数据
			let time = op.xAxis[0].data[xIndex];
			let value = op.series[0].data[xIndex];
			time = time.replace(":","");

			let date = new Date();
			let hour = date.getHours();
			let minute = date.getMinutes();
			if(minute < 10){
				minute = "0"+minute;
			}
			let hm = hour + "" + minute;
			if(Number(hm) < Number(time)){
				let yesterdaytime = (new Date).getTime() - 24*60*60*1000;
				date = new Date(yesterdaytime);
			}
			
			let year = date.getFullYear();
			let month = date.getMonth()+1;
			let day = date.getDate();
			
			
			if($("#epId").val().indexOf('_new')>-1){
				
				if(month < 10){
					month = '0'+month;
				}
				if(day<10){
					day = '0'+day;
				}
			}else{
				let dateStr = year+'-'+month+'-'+day;
				document.getElementById('clickimg').src = imgpathsjson[time];
			}
			
			show('mydiv1');

			//解析告警ID
			let alarmId = "";
			for(let index in alarmId_xAxis){
				if(alarmId_xAxis[index].indexOf(op.xAxis[0].data[xIndex]) > -1){
					alarmId = alarmId_xAxis[index].substr(6);
					break;
				}
			}
			$("#alarmId")[0].innerText = alarmId;

			$.ajax({
				type : "get",
				url : "/system/alarm/getAlarm/" + alarmId,
				success : function(data) {
					if(data) {
						$("#startTime").val(data.begintime);
						$("#endTime").val(data.endtime);
						$("#add_alarm_distance").val(data.distance);
					} else {
						$("#startTime").val("");
						$("#endTime").val("");
						$("#add_alarm_distance").val("");
					}

				}
			});
 
	    }
	});
    function show(id) {
        let objDiv = $("#"+id+"");
        $(objDiv).css("display","block");
    }
    
    function closeFog(){
    	let epId=$("#epId").val();
    	$.ajax({
    		type : "POST",
    		url : "/system/alarm/closeFog/"+epId,
    		success : function(data) {
    			if (data.code == 0) {
    				parent.layer.msg("操作成功");
    				let index = parent.layer.getFrameIndex(window.name); // 获取窗口索引
    				parent.layer.close(index);
    				
    			} else {
    				parent.layer.alert(data.msg);
    				let index = parent.layer.getFrameIndex(window.name); // 获取窗口索引
    				parent.layer.close(index);
    				
    			}

    		}
    	});
    }

	//源统计
	let dom2 = document.getElementById("container2");
	let myChart2 = echarts.init(dom2);
	let imgpathsjson2 = [];
	let option2 = JSON.parse(JSON.stringify(common_options1_zhiban));
	myChart2.getZr().on('click', function (params) {
		let pointInPixel = [params.offsetX, params.offsetY];
		if (myChart2.containPixel('grid',pointInPixel)) {
			/*此处添加具体执行代码*/

			let pointInGrid = myChart2.convertFromPixel({seriesIndex:0},pointInPixel);
			//X轴序号
			let xIndex = pointInGrid[0];

			//获取当前图表的option
			let op = myChart2.getOption();

			//获得图表中我们想要的数据
			let time = op.xAxis[0].data[xIndex];
			let value = op.series[0].data[xIndex];
			time=time.replace(":","");
			//time=Number(time);
			// console.log(time+"："+value+"%");
			// console.log(imgpathsjson2[time]);
			let date = new Date();
			let hour = date.getHours();
			let minute = date.getMinutes();
			if(minute<10){
				minute="0"+minute;
			}
			let hm=hour+""+minute;
			if(Number(hm)<Number(time)){
				let yesterdaytime=(new Date).getTime()-24*60*60*1000;
				date=new Date(yesterdaytime);
			}

			let year = date.getFullYear();
			let month = date.getMonth()+1;
			let day = date.getDate();


			if($("#epId").val().indexOf('_new')>-1){

				if(month<10){
					month='0'+month;
				}
				if(day<10){
					day='0'+day;
				}
			}else{
				let dateStr=year+'-'+month+'-'+day;
				document.getElementById('clickimg').src = imgpathsjson2[time];
			}

			show('mydiv1');

		}
	});
    
    $(function() {
   	    // let hasClose = parent.gethasClose();
   	    // //console.log(hasClose);
   	    // if(hasClose==1){
   	    // 	$("#close").show();
   	    // }
    	if($("#epId").val()=='NT001'||$("#epId").val()=='NT001_new'){
    		$("#videopath").val('https://ainjdjc.jchc.cn/live_video_low/NT001.m3u8')
    	}
    	
    	let videoObject = {
    			container: '#video123',//“#”代表容器的ID，“.”或“”代表容器的class
    			variable: 'player',//该属性必需设置，值等于下面的new chplayer()的对象
    			autoplay:true,//自动播放
    				live:true,
    				html5m3u8:true,
    				mobileCkControls:false,
    		//		    	poster:'http://localhost:8099/sjkvideo_wx/resources/images/fzx_0.jpg',
    			video:$("#videopath").val()//url//视频地址
    		};

    	let player = null;
    	player = new ckplayer(videoObject);
    	document.getElementById('img1').src = $("#path").val();
    	if(!$("#videopath").val()){
    		$("#video123").hide();
    		$("#img1").show();
    	}
    	setInterval(updateImgPath,60000);
        updateImgPath();

        //人工设置能见度及异常摄像头
		$("#rgjzIfram").prop("src",'/system/equipment/zhiban_setting/' + $("#epId").val());
    });

    /**
	 * 更新数据
     */
	function updateImgPath(){
	    //获取图片
        $.ajax({
            type: "post",
            url: "/system/equipment/lookup/updateimgpath/"+$("#epId").val(),
        }).success(function(message) {
            let imgdata=message;
            let p = imgdata.path;
            /* if(imgdata.fMeter>=500){
            	imgdata.fMeter=500;
            	$("#mi").html('>500');
            }else{
            	$("#mi").html(imgdata.fMeter||'0');
            }
            $("#fMeter_V").html(imgdata.fMeter||'0'+"m"); */
            
            /* if(imgdata.fMeter>=200){
            	 $("#zhuangtai").html("晴朗");
            }else if(imgdata.fMeter>=100){
            	$("#zhuangtai").html("大雾");
            }else if(imgdata.fMeter>=50){
            	$("#zhuangtai").html("浓雾");
            }else if(imgdata.fMeter>=30){
            	$("#zhuangtai").html("强浓雾");
            }else if(imgdata.fMeter<30){
            	$("#zhuangtai").html("特强浓雾");
            } */
        }).fail(function(err){
            console.log(err);
        });
        let date = new Date(new Date().getTime()-24*60*60*1000).Format('yyyy-MM-dd hh:mm:ss');
		//获取统计图
        $.ajax({
            type: "get",
            url: "/system/alarm/distanceStatistic",
            dataType:'json',
            data: {epId:$("#epId").val(),date:date}
        }).success(function(data) {
        	if(JSON.stringify(data) == "{}"){
        		layer.msg("统计数据不存在");
				option.xAxis.data = [];
				option.series[0].data = [];
				option.series[1].data = [];
				myChart1.setOption(option, false);
				return;
			}
			alarmId_xAxis = data.alarmId_xAxis.split(",");
            if (option && typeof option === "object") {
                //option.title.text = date;
                option.xAxis.data = data.xAxis.split(",");
                let seriesData = data.series.split(",");
                let general_seriesData = data.general_series.split(",");
                //修改数值
                // for(let i = 0; i < seriesData.length; i++){
                // 	seriesData[i] = parseInt(seriesData[i]);
                // 	if(seriesData[i] <= 30){
                // 		seriesData[i] = parseInt(seriesData[i]/0.3);
                // 	}else if(seriesData[i] <= 50){
                // 		seriesData[i] = parseInt(seriesData[i]*5-50);
                // 	}else if(seriesData[i] <= 100){
                // 		seriesData[i] = parseInt(seriesData[i]*2+100);
                // 	}else if(seriesData[i] <= 200){
                // 		seriesData[i] = parseInt(seriesData[i]+200);
                // 	}else{
                // 		seriesData[i] = parseInt((parseInt(seriesData[i])+200));
                // 	}
                // }
				// for(let i = 0;i < general_seriesData.length; i++){
				// 	general_seriesData[i] = parseInt(general_seriesData[i]);
				// 	if(general_seriesData[i] <= 30){
				// 		general_seriesData[i] = parseInt(general_seriesData[i]/0.3);
				// 	}else if(general_seriesData[i] <= 50){
				// 		general_seriesData[i] = parseInt(general_seriesData[i]*5-50);
				// 	}else if(general_seriesData[i] <= 100){
				// 		general_seriesData[i] = parseInt(general_seriesData[i]*2+100);
				// 	}else if(general_seriesData[i] <= 200){
				// 		general_seriesData[i] = parseInt(general_seriesData[i]+200);
				// 	}else{
				// 		general_seriesData[i] = parseInt((parseInt(general_seriesData[i])+200));
				// 	}
				// }
                option.series[0].data = seriesData;
                option.series[1].data = general_seriesData;
                imgpathsjson = data.imgpaths;
                myChart1.setOption(option, false);
                let series = data.series.split(",");
                let min = parseInt(series[0]);
                let max = parseInt(series[0]);
                let len = series.length;
                for (let i = 1; i < len; i++){
	                if (parseInt(series[i]) < min){
	                	min = parseInt(series[i]);
	                }
	                if (parseInt(series[i]) > max){
	                	max = parseInt(series[i]);
	                }
                }

                $("#maxDay").html(max||0);
				$("#minDay").html(min||0);

				let lastval = series[len-1];
				if(lastval>=500){
					lastval=500;
	            	$("#mi").html('>500');
	            }else{
	            	$("#mi").html(lastval||'0');
	            }
	            $("#fMeter_V").html(lastval||'0'+"m");
            }
			if (option2 && typeof option2 === "object") {
				option2.title.text = "源";
				option2.xAxis.data = data.src_xAxis.split(",");
				let seriesData = data.src_series.split(",");
				for(let i = 0;i<seriesData.length;i++){
					seriesData[i] = parseInt(seriesData[i]);
					if(seriesData[i] <= 30){
						seriesData[i] = parseInt(seriesData[i]/0.3);
					}else if(seriesData[i] <= 50){
						seriesData[i] = parseInt(seriesData[i]*5-50);
					}else if(seriesData[i] <= 100){
						seriesData[i] = parseInt(seriesData[i]*2+100);
					}else if(seriesData[i] <= 200){
						seriesData[i] = parseInt(seriesData[i]+200);
					}else{
						seriesData[i] = parseInt((parseInt(seriesData[i])+200));
					}
				}
				option2.series[0].data = seriesData;
                imgpathsjson2 = data.src_imgpaths;
				myChart2.setOption(option2, false);
				let series = data.src_series.split(",");
				let min = parseInt(series[0]);
				let max = parseInt(series[0]);
				let len = series.length;
				for (let i = 1; i < len; i++){
					if (parseInt(series[i]) < min){
						min = parseInt(series[i]);
					}
					if (parseInt(series[i]) > max){
						max = parseInt(series[i]);
					}
				}

				$("#maxDay").html(max||0);
				$("#minDay").html(min||0);

				let lastval = series[len-1];
				if(lastval>=500){
					lastval=500;
					$("#mi").html('>500');
				}else{
					$("#mi").html(lastval||'0');
				}
				$("#fMeter_V").html(lastval||'0'+"m");
			}
        }).fail(function(err){
            console.log(err);
        });
	}
	$('.fc-close').bind('click',function(event){
        hide('mydiv1');
    });
	function hide(id) {
        let objDiv = $("#"+id+"");
        $(objDiv).css("display", "none");
    }

	//图片刷新3s
	

</script>
</html>